{% extends "base.html" %}
{% block content %}
  <div class="tabs" data-tabs>
    <div class="tabs-bar" role="tablist" aria-label="Dashboard sections">
      <button
        type="button"
        class="tab-button is-active"
        role="tab"
        id="tab-summary-button"
        aria-selected="true"
        aria-controls="tab-summary"
        data-tab-button
        data-tab-target="summary"
      >サマリー</button>
      <button
        type="button"
        class="tab-button"
        role="tab"
        id="tab-ops-button"
        aria-selected="false"
        aria-controls="tab-ops"
        data-tab-button
        data-tab-target="ops"
        tabindex="-1"
      >オペレーション</button>
      <button
        type="button"
        class="tab-button"
        role="tab"
        id="tab-history-button"
        aria-selected="false"
        aria-controls="tab-history"
        data-tab-button
        data-tab-target="history"
        tabindex="-1"
      >履歴</button>
    </div>
    <div class="tab-meta">セクションを切り替えて表示できます。</div>

    <div class="status-bar" data-auto-refresh data-auto-refresh-sec="{{ dashboard.auto_refresh_sec }}" data-auto-refresh-mode="soft">
      <div class="status-left">
        <div class="refresh-meta">
          <span class="refresh-dot" aria-hidden="true"></span>
          <span class="refresh-text">自動更新 {{ dashboard.auto_refresh_sec }}s</span>
          <span class="refresh-status" data-refresh-status></span>
        </div>
        <div class="status-pills">
          {% if dashboard.generated_label %}
            <span class="status-pill">更新 {{ dashboard.generated_label }}</span>
          {% endif %}
          {% if dashboard.snapshot.mode %}
            <span class="status-pill">モード {{ dashboard.snapshot.mode }}</span>
          {% endif %}
          {% if dashboard.snapshot.source %}
            <span class="status-pill">ソース {{ dashboard.snapshot.source }}</span>
          {% endif %}
          {% if dashboard.snapshot.age_sec is not none %}
            <span class="status-pill {{ 'stale' if dashboard.snapshot.stale else 'ok' }}">経過 {{ dashboard.snapshot.age_sec }}s</span>
          {% endif %}
          {% if not dashboard.available %}
            <span class="status-pill warn">snapshot unavailable</span>
          {% endif %}
        </div>
      </div>
      <div class="status-actions">
        <button type="button" class="btn-ghost" data-refresh-now>更新</button>
      </div>
    </div>

    <section class="tab-panel is-active" id="tab-summary" role="tabpanel" aria-labelledby="tab-summary-button" data-tab-panel="summary">
      <div class="card">
    <h2>運用サマリー</h2>
    {% if dashboard.available %}
      {% if dashboard.generated_label %}
        <p class="stat-sub">最終更新: {{ dashboard.generated_label }}</p>
      {% endif %}
    {% else %}
      <p class="stat-sub warning">
        リアルタイムスナップショットを取得できませんでした{% if dashboard.error %}: {{ dashboard.error }}{% endif %}。
        GCS の設定と `run_sync_pipeline.py` の動作を確認してください。
      </p>
    {% endif %}
    <div class="stats-grid">
      {% set daily_class = 'stat-positive' if dashboard.performance.daily_pl_pips >= 0 else 'stat-negative' %}
      <div class="stat-card">
        <div class="stat-label">日次損益（JST）</div>
        <div class="stat-value {{ daily_class }}">{{ "%+.1f"|format(dashboard.performance.daily_pl_pips) }}p</div>
        <div class="stat-sub">{{ "%+.0f"|format(dashboard.performance.daily_pl_jpy) }} 円</div>
        <div class="stat-sub">1L eq {{ "%+.1f"|format(dashboard.performance.daily_pl_eq1l) }}p</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">前日比（口座比）</div>
        {% if dashboard.performance.daily_change_pct is not none %}
          {% set change_class = 'stat-positive' if dashboard.performance.daily_change_pct >= 0 else 'stat-negative' %}
          <div class="stat-value {{ change_class }}">{{ "%+.1f"|format(dashboard.performance.daily_change_pct) }}%</div>
        {% else %}
          <div class="stat-value">-</div>
        {% endif %}
        <div class="stat-sub">差分 {{ "%+.0f"|format(dashboard.performance.daily_change_jpy) }} 円</div>
        {% if dashboard.performance.daily_change_equity %}
          {% if dashboard.performance.daily_change_equity_source == "balance" %}
            <div class="stat-sub">基準Balance {{ "%.0f"|format(dashboard.performance.daily_change_equity) }} 円</div>
          {% else %}
            <div class="stat-sub">基準NAV {{ "%.0f"|format(dashboard.performance.daily_change_equity) }} 円</div>
          {% endif %}
        {% else %}
          <div class="stat-sub">基準NAV -</div>
        {% endif %}
      </div>
      {% set weekly_class = 'stat-positive' if dashboard.performance.weekly_pl_pips >= 0 else 'stat-negative' %}
      <div class="stat-card">
        <div class="stat-label">週次損益（JST）</div>
        <div class="stat-value {{ weekly_class }}">{{ "%+.1f"|format(dashboard.performance.weekly_pl_pips) }}p</div>
        <div class="stat-sub">{{ "%+.0f"|format(dashboard.performance.weekly_pl_jpy) }} 円</div>
        <div class="stat-sub">1L eq {{ "%+.1f"|format(dashboard.performance.weekly_pl_eq1l) }}p</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">年初残高比（手動除外）</div>
        {% if dashboard.ytd_summary.bot_return_pct is not none %}
          {% set ytd_class = 'stat-positive' if dashboard.ytd_summary.bot_return_pct >= 0 else 'stat-negative' %}
          <div class="stat-value {{ ytd_class }}">{{ "%+.2f"|format(dashboard.ytd_summary.bot_return_pct) }}%</div>
        {% else %}
          <div class="stat-value">-</div>
        {% endif %}
        <div class="stat-sub">YTD {{ "%+.0f"|format(dashboard.ytd_summary.bot_profit_jpy) }} 円</div>
        {% if dashboard.ytd_summary.start_balance %}
          {% if dashboard.ytd_summary.start_balance_source == "metric" %}
            <div class="stat-sub">開始残高 {{ "%.0f"|format(dashboard.ytd_summary.start_balance) }} 円</div>
          {% else %}
            <div class="stat-sub">開始残高 -</div>
          {% endif %}
        {% else %}
          <div class="stat-sub">開始残高 -</div>
        {% endif %}
      </div>
      <div class="stat-card">
        <div class="stat-label">勝率</div>
        {% if dashboard.performance.recent_closed %}
          <div class="stat-value">{{ "%.1f"|format(dashboard.performance.win_rate_percent) }}%</div>
          <div class="stat-sub">{{ dashboard.performance.wins }} 勝 / {{ dashboard.performance.losses }} 敗</div>
        {% else %}
          <div class="stat-value">-</div>
          <div class="stat-sub">十分な検証データがありません</div>
        {% endif %}
      </div>
      <div class="stat-card">
        <div class="stat-label">決済件数 (7d)</div>
        <div class="stat-value">{{ dashboard.performance.recent_closed }}</div>
        <div class="stat-sub">累積 {{ dashboard.performance.total_trades }} 件</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">保有ポジション</div>
        <div class="stat-value">{{ dashboard.performance.open_positions }}</div>
        <div class="stat-sub">ネット units {{ "%+.0f"|format(dashboard.performance.net_units) }}</div>
        <div class="stat-sub">未実現 {{ "%+.1f"|format(dashboard.performance.unrealized_pl_pips) }}p / {{ "%+.0f"|format(dashboard.performance.unrealized_pl_jpy) }} 円（上段は確定損益）</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">新規トレード</div>
        <div class="stat-value">{{ dashboard.performance.new_trades }}</div>
        <div class="stat-sub">最終トレード {{ dashboard.performance.last_trade_at or '-' }}</div>
      </div>
    </div>

    <div class="section-title">リスク / マージン</div>
    <div class="stats-grid">
      <div class="stat-card compact">
        <div class="stat-label">Margin使用率</div>
        {% if dashboard.account.margin_usage_pct is not none %}
          <div class="stat-value">{{ "%.1f"|format(dashboard.account.margin_usage_pct) }}%</div>
          <div class="stat-sub">ratio {{ "%.3f"|format(dashboard.account.margin_usage_ratio) }}</div>
        {% else %}
          <div class="stat-value">-</div>
          <div class="stat-sub">ratio -</div>
        {% endif %}
      </div>
      <div class="stat-card compact">
        <div class="stat-label">Free margin</div>
        {% if dashboard.account.free_margin_pct is not none %}
          <div class="stat-value">{{ "%.1f"|format(dashboard.account.free_margin_pct) }}%</div>
          <div class="stat-sub">ratio {{ "%.3f"|format(dashboard.account.free_margin_ratio) }}</div>
        {% else %}
          <div class="stat-value">-</div>
          <div class="stat-sub">ratio -</div>
        {% endif %}
      </div>
      <div class="stat-card compact">
        <div class="stat-label">Health buffer</div>
        {% if dashboard.account.health_buffer_pct is not none %}
          <div class="stat-value">{{ "%.1f"|format(dashboard.account.health_buffer_pct) }}%</div>
          <div class="stat-sub">ratio {{ "%.3f"|format(dashboard.account.health_buffer) }}</div>
        {% else %}
          <div class="stat-value">-</div>
          <div class="stat-sub">ratio -</div>
        {% endif %}
      </div>
      <div class="stat-card compact">
        <div class="stat-label">NAV (JPY)</div>
        {% if dashboard.account.nav is not none %}
          <div class="stat-value">{{ "{:,.0f}".format(dashboard.account.nav) }}</div>
          <div class="stat-sub">metric: account.nav</div>
        {% else %}
          <div class="stat-value">-</div>
          <div class="stat-sub">metric: account.nav</div>
        {% endif %}
      </div>
      <div class="stat-card compact">
        <div class="stat-label">Balance (JPY)</div>
        {% if dashboard.account.balance is not none %}
          <div class="stat-value">{{ "{:,.0f}".format(dashboard.account.balance) }}</div>
          <div class="stat-sub">metric: account.balance</div>
        {% else %}
          <div class="stat-value">-</div>
          <div class="stat-sub">metric: account.balance</div>
        {% endif %}
      </div>
    </div>

    {% if dashboard.performance.pockets %}
      <div class="section-title">Pocket成績（累積）</div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Pocket</th>
              <th>損益 (pips)</th>
              <th>損益 (JPY)</th>
              <th>件数</th>
              <th>勝率</th>
              <th>PF</th>
            </tr>
          </thead>
          <tbody>
          {% for row in dashboard.performance.pockets %}
            {% set pill_class = 'pill gain' if row.pips > 0 else 'pill loss' if row.pips < 0 else 'pill neutral' %}
            <tr>
              <td>{{ row.pocket }}</td>
              <td><span class="{{ pill_class }}">{{ "%+.1f"|format(row.pips) }}</span></td>
              <td>{{ "%+.0f"|format(row.jpy) }}</td>
              <td>{{ row.trades }}</td>
              <td>
                {% if row.win_rate is not none %}
                  {{ "%.1f"|format(row.win_rate) }}%
                {% else %}
                  -
                {% endif %}
              </td>
              <td>
                {% if row.pf is not none %}
                  {{ "%.2f"|format(row.pf) }}
                {% else %}
                  -
                {% endif %}
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}

  </div>

      <div class="card" data-tabs data-tabs-local data-tabs-key="chart" data-chart-tabs>
        <div class="chart-header">
          <div>
            <h2>パフォーマンスチャート</h2>
            <div class="tagline">損益とエントリー位置を切り替えて確認できます。</div>
          </div>
          <div class="tabs-bar" role="tablist" aria-label="Chart mode">
            <button
              type="button"
              class="tab-button is-active"
              role="tab"
              aria-selected="true"
              data-tab-button
              data-tab-target="chart-performance"
            >損益</button>
            <button
              type="button"
              class="tab-button"
              role="tab"
              aria-selected="false"
              data-tab-button
              data-tab-target="chart-price"
              tabindex="-1"
            >価格</button>
          </div>
        </div>
        {% if dashboard.charts and dashboard.charts.available %}
          <div class="tab-panel is-active" data-tab-panel="chart-performance">
            <div data-chart="performance">
              <div class="chart-toolbar">
                <div class="range-buttons">
                  <button type="button" class="range-button" data-range="5m">5分</button>
                  <button type="button" class="range-button" data-range="1h">1時間</button>
                  <button type="button" class="range-button is-active" data-range="1d">1日</button>
                  <button type="button" class="range-button" data-range="1w">週</button>
                  <button type="button" class="range-button" data-range="1m">月</button>
                  <button type="button" class="range-button" data-range="1y">年</button>
                </div>
                <div class="chart-meta" data-chart-meta="performance"></div>
              </div>
              <div class="chart-wrap">
                <svg class="chart-svg" data-chart-canvas="performance" aria-label="Performance chart"></svg>
                <div class="chart-empty" data-chart-empty="performance">NO DATA</div>
              </div>
            </div>
          </div>
          <div class="tab-panel" data-tab-panel="chart-price">
            <div data-chart="price">
              <div class="chart-toolbar">
                <div class="range-buttons">
                  <button type="button" class="range-button" data-range="5m">5分</button>
                  <button type="button" class="range-button" data-range="1h">1時間</button>
                  <button type="button" class="range-button is-active" data-range="1d">1日</button>
                  <button type="button" class="range-button" data-range="1w">週</button>
                  <button type="button" class="range-button" data-range="1m">月</button>
                  <button type="button" class="range-button" data-range="1y">年</button>
                </div>
                <div class="chart-meta" data-chart-meta="price"></div>
                <div class="chart-legend">
                  <span class="legend-item"><span class="legend-shape legend-entry" aria-hidden="true"></span>Entry</span>
                  <span class="legend-item"><span class="legend-shape legend-exit" aria-hidden="true"></span>Exit</span>
                  <span class="legend-item"><span class="legend-dot legend-long" aria-hidden="true"></span>Long</span>
                  <span class="legend-item"><span class="legend-dot legend-short" aria-hidden="true"></span>Short</span>
                </div>
              </div>
              <div class="chart-wrap">
                <svg class="chart-svg" data-chart-canvas="price" aria-label="Price chart"></svg>
                <div class="chart-empty" data-chart-empty="price">NO DATA</div>
                <div class="chart-tooltip" data-chart-tooltip="price" aria-hidden="true"></div>
              </div>
              <div class="chart-markers" data-chart-markers="price">
                <div class="section-subtitle">エントリーポイント</div>
                <div class="table-wrap chart-marker-table">
                  <table>
                    <thead>
                      <tr>
                        <th>時刻</th>
                        <th>Side</th>
                        <th>Pocket</th>
                        <th>Worker</th>
                        <th>Strategy</th>
                        <th>Units</th>
                        <th>Price</th>
                      </tr>
                    </thead>
                    <tbody data-chart-markers-body="price"></tbody>
                  </table>
                </div>
                <p class="tagline" data-chart-markers-empty="price">レンジ内エントリーがありません。</p>
              </div>
            </div>
          </div>
        {% else %}
          <p class="tagline">チャートデータがありません。</p>
        {% endif %}
      </div>

      <div class="card">
        <h2>オープンポジション</h2>
        <div class="tagline">
          合計 {{ dashboard.open_summary.total_positions }} 件 /
          ロング units {{ "%+.0f"|format(dashboard.open_summary.long_units) }} /
          ショート units {{ "%+.0f"|format(-dashboard.open_summary.short_units) }} /
          ネット units {{ "%+.0f"|format(dashboard.open_summary.net_units) }} /
          未実現 {{ "%+.1f"|format(dashboard.open_summary.unrealized_pl_pips) }}p / {{ "%+.0f"|format(dashboard.open_summary.unrealized_pl_jpy) }} 円
          {% if dashboard.open_summary.meta %}
            {% if dashboard.open_summary.meta.stale %}
              / 更新 {{ dashboard.open_summary.meta.age_sec }}s前 (stale)
            {% else %}
              / 更新 {{ dashboard.open_summary.meta.age_sec }}s前
            {% endif %}
          {% endif %}
        </div>
        {% if dashboard.open_summary.pockets %}
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Pocket</th>
                  <th>Long</th>
                  <th>Short</th>
                  <th>Net</th>
                  <th>Avg L</th>
                  <th>Avg S</th>
                  <th>未実現 (pips)</th>
                  <th>未実現 (JPY)</th>
                  <th>建玉数</th>
                </tr>
              </thead>
              <tbody>
              {% for row in dashboard.open_summary.pockets %}
                {% set pill_class = 'pill gain' if row.unrealized_pips > 0 else 'pill loss' if row.unrealized_pips < 0 else 'pill neutral' %}
                <tr>
                  <td>{{ row.pocket }}</td>
                  <td>{{ "{:,}".format(row.long_units) }}</td>
                  <td>{{ "{:,}".format(row.short_units) }}</td>
                  <td>{{ "%+.0f"|format(row.units) }}</td>
                  <td>
                    {% if row.long_avg_price is not none %}
                      {{ "%.3f"|format(row.long_avg_price) }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td>
                    {% if row.short_avg_price is not none %}
                      {{ "%.3f"|format(row.short_avg_price) }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td><span class="{{ pill_class }}">{{ "%+.2f"|format(row.unrealized_pips) }}p</span></td>
                  <td>{{ "%+.0f"|format(row.unrealized_jpy) }}</td>
                  <td>{{ row.trades }}</td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
          {% if dashboard.open_summary.open_trades %}
            <div class="section-subtitle" style="margin-top:1rem;">各ポジション</div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Open</th>
                    <th>Pocket</th>
                    <th>Worker</th>
                    <th>Strategy</th>
                    <th>Side</th>
                    <th>Units</th>
                    <th>Entry</th>
                    <th>未実現 (pips)</th>
                    <th>未実現 (JPY)</th>
                  </tr>
                </thead>
                <tbody>
                {% for row in dashboard.open_summary.open_trades %}
                  {% set pill_class = 'pill gain' if row.unrealized_pips > 0 else 'pill loss' if row.unrealized_pips < 0 else 'pill neutral' %}
                  <tr>
                    <td class="mono nowrap">{{ row.open_label }}</td>
                    <td>{{ row.pocket }}</td>
                    <td class="mono nowrap">{{ row.worker }}</td>
                    <td>{{ row.strategy }}</td>
                    <td>{{ row.side }}</td>
                    <td>{{ "{:,}".format(row.units_abs) }}</td>
                    <td>
                      {% if row.entry_price is not none %}
                        {{ "%.3f"|format(row.entry_price) }}
                      {% else %}
                        -
                      {% endif %}
                    </td>
                    <td><span class="{{ pill_class }}">{{ "%+.2f"|format(row.unrealized_pips) }}p</span></td>
                    <td>{{ "%+.0f"|format(row.unrealized_jpy) }}</td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            </div>
          {% endif %}
        {% else %}
          <p class="tagline">現在オープンポジションはありません。</p>
        {% endif %}
      </div>

      <div class="card" data-tabs data-tabs-local data-tabs-key="profit">
        <div class="chart-header">
          <div>
            <h2>利益表（{{ dashboard.profit_tables.year_start or '-' }}〜 / {{ dashboard.profit_tables.timezone }} / 手動除外）</h2>
            <div class="tagline">日次・週次・月次を切り替えて確認できます。</div>
          </div>
          <div class="tabs-bar" role="tablist" aria-label="Profit table range">
            <button
              type="button"
              class="tab-button is-active"
              role="tab"
              aria-selected="true"
              data-tab-button
              data-tab-target="profit-daily"
            >日次</button>
            <button
              type="button"
              class="tab-button"
              role="tab"
              aria-selected="false"
              data-tab-button
              data-tab-target="profit-weekly"
              tabindex="-1"
            >週次</button>
            <button
              type="button"
              class="tab-button"
              role="tab"
              aria-selected="false"
              data-tab-button
              data-tab-target="profit-monthly"
              tabindex="-1"
            >月次</button>
          </div>
        </div>
        {% if dashboard.profit_tables and dashboard.profit_tables.daily %}
          <div class="tab-panel is-active" data-tab-panel="profit-daily">
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>日次</th>
                    <th>損益 (pips)</th>
                    <th>損益 (JPY)</th>
                    <th>開始残高</th>
                    <th>残高比</th>
                    <th>件数</th>
                    <th>勝率</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in dashboard.profit_tables.daily %}
                    {% set pill_class = 'pill gain' if row.pips > 0 else 'pill loss' if row.pips < 0 else 'pill neutral' %}
                    <tr>
                      <td>{{ row.label }}</td>
                      <td><span class="{{ pill_class }}">{{ "%+.1f"|format(row.pips) }}</span></td>
                      <td>{{ "%+.0f"|format(row.jpy) }}</td>
                      <td>{% if row.start_balance %}{{ "%.0f"|format(row.start_balance) }}{% else %}-{% endif %}</td>
                      <td>{% if row.return_pct is not none %}{{ "%+.2f"|format(row.return_pct) }}%{% else %}-{% endif %}</td>
                      <td>{{ row.trades }}</td>
                      <td>{{ "%.1f"|format(row.win_rate * 100.0) }}%</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <div class="tab-panel" data-tab-panel="profit-weekly">
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>週次</th>
                    <th>損益 (pips)</th>
                    <th>損益 (JPY)</th>
                    <th>開始残高</th>
                    <th>残高比</th>
                    <th>件数</th>
                    <th>勝率</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in dashboard.profit_tables.weekly %}
                    {% set pill_class = 'pill gain' if row.pips > 0 else 'pill loss' if row.pips < 0 else 'pill neutral' %}
                    <tr>
                      <td>{{ row.label }}</td>
                      <td><span class="{{ pill_class }}">{{ "%+.1f"|format(row.pips) }}</span></td>
                      <td>{{ "%+.0f"|format(row.jpy) }}</td>
                      <td>{% if row.start_balance %}{{ "%.0f"|format(row.start_balance) }}{% else %}-{% endif %}</td>
                      <td>{% if row.return_pct is not none %}{{ "%+.2f"|format(row.return_pct) }}%{% else %}-{% endif %}</td>
                      <td>{{ row.trades }}</td>
                      <td>{{ "%.1f"|format(row.win_rate * 100.0) }}%</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <div class="tab-panel" data-tab-panel="profit-monthly">
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>月次</th>
                    <th>損益 (pips)</th>
                    <th>損益 (JPY)</th>
                    <th>開始残高</th>
                    <th>残高比</th>
                    <th>件数</th>
                    <th>勝率</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in dashboard.profit_tables.monthly %}
                    {% set pill_class = 'pill gain' if row.pips > 0 else 'pill loss' if row.pips < 0 else 'pill neutral' %}
                    <tr>
                      <td>{{ row.label }}</td>
                      <td><span class="{{ pill_class }}">{{ "%+.1f"|format(row.pips) }}</span></td>
                      <td>{{ "%+.0f"|format(row.jpy) }}</td>
                      <td>{% if row.start_balance %}{{ "%.0f"|format(row.start_balance) }}{% else %}-{% endif %}</td>
                      <td>{% if row.return_pct is not none %}{{ "%+.2f"|format(row.return_pct) }}%{% else %}-{% endif %}</td>
                      <td>{{ row.trades }}</td>
                      <td>{{ "%.1f"|format(row.win_rate * 100.0) }}%</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        {% else %}
          <p class="tagline">利益表データがありません。</p>
        {% endif %}
      </div>

      <div class="card">
        <h2>最近のトレード</h2>
        <div class="tagline">最新15件を表示します。詳細は履歴タブで確認できます。</div>
        {% set summary_trades = dashboard.recent_trades[:15] %}
        {% if summary_trades %}
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>更新</th>
                  <th>Pocket</th>
                  <th>Worker</th>
                  <th>Strategy</th>
                  <th>方向</th>
                  <th>数量</th>
                  <th>損益 (pips)</th>
                  <th>損益 (JPY)</th>
                  <th>決済理由</th>
                </tr>
              </thead>
              <tbody>
              {% for row in summary_trades %}
                {% set pill_class = 'pill gain' if row.kind == 'gain' else 'pill loss' if row.kind == 'loss' else 'pill neutral' %}
                <tr>
                  <td class="mono nowrap">{{ row.updated_label }}</td>
                  <td>{{ row.pocket }}</td>
                  <td class="mono nowrap">{{ row.worker }}</td>
                  <td>{{ row.strategy }}</td>
                  <td>{{ row.direction }}</td>
                  <td>{{ "{:,}".format(row.units_abs) }}</td>
                  <td><span class="{{ pill_class }}">{{ "%+.1f"|format(row.pl_pips) }}</span></td>
                  <td>{{ "%+.0f"|format(row.pl_jpy) }}</td>
                  <td>{{ row.close_reason }}</td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="tagline">トレード履歴がありません。</p>
        {% endif %}
      </div>

      <div class="card">
        <h2>システムヘルス</h2>
        <div class="tagline">リアルタイム指標の概要です（詳細はオペレーション）。</div>
        <div class="stats-grid">
          <div class="stat-card compact">
            <div class="stat-label">データ遅延</div>
            <div class="stat-value {{ dashboard.system.data_lag_level }}">
              {% if dashboard.system.data_lag_ms is not none %}
                {{ "%.0f"|format(dashboard.system.data_lag_ms) }}ms
              {% else %}
                -
              {% endif %}
            </div>
            <div class="stat-sub">SLO 1500ms</div>
          </div>
          <div class="stat-card compact">
            <div class="stat-label">判断遅延</div>
            <div class="stat-value {{ dashboard.system.decision_latency_level }}">
              {% if dashboard.system.decision_latency_ms is not none %}
                {{ "%.0f"|format(dashboard.system.decision_latency_ms) }}ms
              {% else %}
                -
              {% endif %}
            </div>
            <div class="stat-sub">SLO 2000ms</div>
          </div>
          <div class="stat-card compact">
            <div class="stat-label">ヘルスビート</div>
            <div class="stat-value {{ dashboard.system.healthbeat_level }}">
              {% if dashboard.system.healthbeat_age_min is not none %}
                {{ dashboard.system.healthbeat_age_min }}分前
              {% else %}
                -
              {% endif %}
            </div>
            <div class="stat-sub">最終 {{ dashboard.system.healthbeat_label or '-' }}</div>
          </div>
          <div class="stat-card compact">
            <div class="stat-label">最終シグナル</div>
            <div class="stat-value {{ dashboard.system.signals_last_level }}">
              {% if dashboard.system.signals_last_age_min is not none %}
                {{ dashboard.system.signals_last_age_min }}分前
              {% else %}
                -
              {% endif %}
            </div>
            <div class="stat-sub">最終 {{ dashboard.system.signals_last_label or '-' }}</div>
          </div>
          <div class="stat-card compact">
            <div class="stat-label">注文 (1h)</div>
            <div class="stat-value">
              {% if dashboard.system.orders_total_1h is not none %}
                {{ dashboard.system.orders_total_1h }}
              {% else %}
                -
              {% endif %}
            </div>
            <div class="stat-sub">status集計</div>
          </div>
        </div>
      </div>
    </section>

    <section class="tab-panel" id="tab-ops" role="tabpanel" aria-labelledby="tab-ops-button" data-tab-panel="ops">
      <div class="card">
        <h2>システムヘルス</h2>
    <div class="tagline">データ遅延・判断遅延・ヘルスビート・シグナルの最新状況をまとめています。</div>
    <div class="stats-grid">
      <div class="stat-card compact">
        <div class="stat-label">データ遅延</div>
        <div class="stat-value {{ dashboard.system.data_lag_level }}">
          {% if dashboard.system.data_lag_ms is not none %}
            {{ "%.0f"|format(dashboard.system.data_lag_ms) }}ms
          {% else %}
            -
          {% endif %}
        </div>
        <div class="stat-sub">SLO 1500ms</div>
      </div>
      <div class="stat-card compact">
        <div class="stat-label">判断遅延</div>
        <div class="stat-value {{ dashboard.system.decision_latency_level }}">
          {% if dashboard.system.decision_latency_ms is not none %}
            {{ "%.0f"|format(dashboard.system.decision_latency_ms) }}ms
          {% else %}
            -
          {% endif %}
        </div>
        <div class="stat-sub">SLO 2000ms</div>
      </div>
      <div class="stat-card compact">
        <div class="stat-label">ヘルスビート</div>
        <div class="stat-value {{ dashboard.system.healthbeat_level }}">
          {% if dashboard.system.healthbeat_age_min is not none %}
            {{ dashboard.system.healthbeat_age_min }}分前
          {% else %}
            -
          {% endif %}
        </div>
        <div class="stat-sub">最終 {{ dashboard.system.healthbeat_label or '-' }}</div>
      </div>
      <div class="stat-card compact">
        <div class="stat-label">最終シグナル</div>
        <div class="stat-value {{ dashboard.system.signals_last_level }}">
          {% if dashboard.system.signals_last_age_min is not none %}
            {{ dashboard.system.signals_last_age_min }}分前
          {% else %}
            -
          {% endif %}
        </div>
        <div class="stat-sub">最終 {{ dashboard.system.signals_last_label or '-' }}</div>
      </div>
      <div class="stat-card compact">
        <div class="stat-label">注文 (1h)</div>
        <div class="stat-value">
          {% if dashboard.system.orders_total_1h is not none %}
            {{ dashboard.system.orders_total_1h }}
          {% else %}
            -
          {% endif %}
        </div>
        <div class="stat-sub">ステータス集計</div>
      </div>
    </div>

    <div class="section-title">注文ステータス（直近1時間）</div>
    {% if dashboard.system.orders_status_1h %}
      <div class="pill-row">
        {% for row in dashboard.system.orders_status_1h %}
          <span class="pill {{ row.level }}">{{ row.status }} {{ row.count }}</span>
        {% endfor %}
      </div>
    {% else %}
      <p class="tagline">直近1時間の注文データがありません。</p>
    {% endif %}

    <div class="section-title">最近のシグナル / 注文</div>
    <div class="split-equal">
      <div>
        <div class="section-subtitle">最近のシグナル</div>
        {% if dashboard.system.signals_recent %}
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>時刻</th>
                  <th>Pocket</th>
                  <th>戦略</th>
                  <th>アクション</th>
                  <th>信頼度</th>
                  <th>Units</th>
                  <th>ID</th>
                </tr>
              </thead>
              <tbody>
              {% for row in dashboard.system.signals_recent %}
                <tr>
                  <td class="mono nowrap">{{ row.ts_label }}</td>
                  <td>{{ row.pocket }}</td>
                  <td>{{ row.strategy }}</td>
                  <td>{{ row.action }}</td>
                  <td>{{ row.confidence if row.confidence is not none else '-' }}</td>
                  <td>{{ row.units if row.units is not none else '-' }}</td>
                  <td class="mono"><span title="{{ row.id_full }}">{{ row.id_short }}</span></td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="tagline">シグナルの直近履歴がありません。</p>
        {% endif %}
      </div>
      <div>
        <div class="section-subtitle">最近の注文</div>
        {% if dashboard.system.orders_last %}
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>時刻</th>
                  <th>Pocket</th>
                  <th>方向</th>
                  <th>Units</th>
                  <th>状態</th>
                  <th>ID</th>
                </tr>
              </thead>
              <tbody>
              {% for row in dashboard.system.orders_last %}
                <tr>
                  <td class="mono nowrap">{{ row.ts_label }}</td>
                  <td>{{ row.pocket }}</td>
                  <td>{{ row.side }}</td>
                  <td>{{ row.units if row.units is not none else '-' }}</td>
                  <td class="{{ row.status_level }}">{{ row.status }}</td>
                  <td class="mono"><span title="{{ row.id_full }}">{{ row.id_short }}</span></td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="tagline">注文の直近履歴がありません。</p>
        {% endif %}
      </div>
    </div>
  </div>

      <div class="card">
        <h2>緊急操作</h2>
        <div class="tagline">
          取引ワーカーを一括で停止/再開します。実行には Ops トークンが必要です。
        </div>
        {% if ops_notice %}
          <p class="tagline">{{ ops_notice }}</p>
        {% endif %}
        {% if ops_error %}
          <p class="tagline warning">{{ ops_error }}</p>
        {% endif %}
        {% if ops_enabled %}
          <div class="split-equal">
            <form method="post" action="/ops/control" class="form-block">
              <input type="hidden" name="action" value="stop">
              <div class="field-grid">
                <label class="field-label" for="ops-stop-confirm">確認テキスト</label>
                <input id="ops-stop-confirm" name="confirm" class="input-compact" placeholder="STOP" autocomplete="off" required>
                <label class="field-label" for="ops-stop-token">Ops トークン</label>
                <input id="ops-stop-token" name="ops_token" type="password" class="input-compact" placeholder="ui_ops_token" required>
              </div>
              <div class="buttons" style="margin-top:0.8rem;">
                <button type="submit" class="danger">緊急停止</button>
              </div>
            </form>
            <form method="post" action="/ops/control" class="form-block">
              <input type="hidden" name="action" value="start">
              <div class="field-grid">
                <label class="field-label" for="ops-start-confirm">確認テキスト</label>
                <input id="ops-start-confirm" name="confirm" class="input-compact" placeholder="START" autocomplete="off" required>
                <label class="field-label" for="ops-start-token">Ops トークン</label>
                <input id="ops-start-token" name="ops_token" type="password" class="input-compact" placeholder="ui_ops_token" required>
              </div>
              <div class="buttons" style="margin-top:0.8rem;">
                <button type="submit" class="success">再開</button>
              </div>
            </form>
          </div>
        {% else %}
          <p class="tagline warning">ui_ops_token が未設定のため操作できません。</p>
        {% endif %}
      </div>
    </section>

    <section class="tab-panel" id="tab-history" role="tabpanel" aria-labelledby="tab-history-button" data-tab-panel="history">
      <div class="card">
        <h2>1時間ごとのトレード</h2>
        <div class="tagline">
          直近 {{ dashboard.hourly_trades.lookback_hours }}h / {{ dashboard.hourly_trades.timezone }}
          {% if dashboard.hourly_trades.exclude_manual %}/ 手動除外{% endif %}
        </div>
        {% if dashboard.hourly_trades.hours %}
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>時間</th>
                  <th>損益 (pips)</th>
                  <th>損益 (JPY)</th>
                  <th>件数</th>
                  <th>勝率</th>
                </tr>
              </thead>
              <tbody>
              {% for row in dashboard.hourly_trades.hours %}
                {% set pill_class = 'pill gain' if row.pips > 0 else 'pill loss' if row.pips < 0 else 'pill neutral' %}
                <tr>
                  <td class="mono nowrap">{{ row.label }}</td>
                  <td><span class="{{ pill_class }}">{{ "%+.1f"|format(row.pips) }}</span></td>
                  <td>{{ "%+.0f"|format(row.jpy) }}</td>
                  <td>{{ row.trades }}</td>
                  <td>{{ "%.1f"|format(row.win_rate * 100.0) }}%</td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="tagline">直近のトレードがありません。</p>
        {% endif %}
      </div>

      <div class="card">
        <h2>最近のトレード</h2>
    <div class="tagline">更新順で最新{{ dashboard.recent_trades_limit }}件を表示します。状態/決済理由も併記します。</div>
    {% if dashboard.recent_trades %}
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>更新</th>
              <th>Pocket</th>
              <th>Worker</th>
              <th>Strategy</th>
              <th>方向</th>
              <th>数量</th>
              <th>Entry</th>
              <th>Close</th>
              <th>損益 (pips)</th>
              <th>損益 (JPY)</th>
              <th>状態</th>
              <th>決済理由</th>
            </tr>
          </thead>
          <tbody>
          {% for row in dashboard.recent_trades %}
            {% set pill_class = 'pill gain' if row.kind == 'gain' else 'pill loss' if row.kind == 'loss' else 'pill neutral' %}
            <tr>
              <td class="mono nowrap">{{ row.updated_label }}</td>
              <td>{{ row.pocket }}</td>
              <td class="mono nowrap">{{ row.worker }}</td>
              <td>{{ row.strategy }}</td>
              <td>{{ row.direction }}</td>
              <td>{{ "{:,}".format(row.units_abs) }}</td>
              <td>
                {% if row.entry_price is not none %}
                  {{ "%.3f"|format(row.entry_price) }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>
                {% if row.close_price is not none %}
                  {{ "%.3f"|format(row.close_price) }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td><span class="{{ pill_class }}">{{ "%+.1f"|format(row.pl_pips) }}</span></td>
              <td>{{ "%+.0f"|format(row.pl_jpy) }}</td>
              <td>{{ row.state }}</td>
              <td>{{ row.close_reason }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="tagline">トレード履歴がありません。</p>
    {% endif %}
  </div>

  <div class="card">
    <h2>トレードハイライト</h2>
    <div class="split-equal">
      <div>
        <div class="section-subtitle">トップ勝ち／負け</div>
        {% if dashboard.highlights_top %}
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>チケット</th>
                  <th>Pocket</th>
                  <th>Worker</th>
                  <th>損益 (pips)</th>
                  <th>損益 (JPY)</th>
                  <th>決済時刻</th>
                </tr>
              </thead>
              <tbody>
              {% for row in dashboard.highlights_top %}
                {% set pill_class = 'pill gain' if row.kind == 'gain' else 'pill loss' %}
                <tr>
                  <td>{{ row.ticket_id }}</td>
                  <td>{{ row.pocket }}</td>
                  <td class="mono nowrap">{{ row.worker }}</td>
                  <td><span class="{{ pill_class }}">{{ "%+.1f"|format(row.pl_pips) }}</span></td>
                  <td>{{ "%+.0f"|format(row.pl_jpy) }}</td>
                  <td>{{ row.closed_at or '-' }}</td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="tagline">十分なトレード実績がありません。</p>
        {% endif %}
      </div>
      <div>
        <div class="section-subtitle">最新トレード</div>
        {% if dashboard.highlights_recent %}
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>チケット</th>
                  <th>Pocket</th>
                  <th>Worker</th>
                  <th>損益 (pips)</th>
                  <th>損益 (JPY)</th>
                  <th>決済時刻</th>
                </tr>
              </thead>
              <tbody>
              {% for row in dashboard.highlights_recent %}
                {% set pill_class = 'pill gain' if row.kind == 'gain' else 'pill loss' if row.kind == 'loss' else 'pill neutral' %}
                <tr>
                  <td>{{ row.ticket_id }}</td>
                  <td>{{ row.pocket }}</td>
                  <td class="mono nowrap">{{ row.worker }}</td>
                  <td><span class="{{ pill_class }}">{{ "%+.1f"|format(row.pl_pips) }}</span></td>
                  <td>{{ "%+.0f"|format(row.pl_jpy) }}</td>
                  <td>{{ row.closed_at or '-' }}</td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="tagline">最新トレード情報がまだありません。</p>
        {% endif %}
      </div>
    </div>
      </div>
    </section>
  </div>

  <script id="qr-chart-data" type="application/json">{{ dashboard.charts_json | safe }}</script>
  <script>
    (() => {
      const dataEl = document.getElementById("qr-chart-data");
      if (!dataEl) return;
      let chartData = null;
      try {
        chartData = JSON.parse(dataEl.textContent || "{}");
      } catch (err) {
        return;
      }
      if (!chartData || !chartData.available) return;

      const perfContainer = document.querySelector('[data-chart="performance"]');
      const priceContainer = document.querySelector('[data-chart="price"]');
      const viewState = {
        performance: {},
        price: {},
      };

      const setActiveButton = (container, key) => {
        const buttons = Array.from(container.querySelectorAll(".range-button"));
        buttons.forEach((btn) => {
          btn.classList.toggle("is-active", btn.dataset.range === key);
        });
      };

      const clamp = (val, min, max) => Math.max(min, Math.min(max, val));
      const escapeHtml = (value) => String(value ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#39;");
      const formatTs = (ts) => {
        const dt = new Date(ts);
        if (Number.isNaN(dt.getTime())) return "-";
        const jst = new Date(dt.getTime() + 9 * 60 * 60 * 1000);
        const iso = jst.toISOString().replace("T", " ").slice(0, 16);
        return `${iso} JST`;
      };
      const getOrInitView = (chartKey, rangeKey, baseMin, baseMax, defaultMin, defaultMax) => {
        if (!viewState[chartKey]) viewState[chartKey] = {};
        let state = viewState[chartKey][rangeKey];
        if (!state || typeof state.min !== "number" || typeof state.max !== "number") {
          const min = typeof defaultMin === "number" ? defaultMin : baseMin;
          const max = typeof defaultMax === "number" ? defaultMax : baseMax;
          state = { min, max };
          viewState[chartKey][rangeKey] = state;
        }
        const baseSpan = Math.max(1, baseMax - baseMin);
        let minSpan = Math.max(baseSpan / 200, 60000);
        minSpan = Math.min(minSpan, baseSpan);
        let min = state.min;
        let max = state.max;
        let span = max - min;
        if (span < minSpan) {
          const center = min + span / 2;
          min = center - minSpan / 2;
          max = center + minSpan / 2;
        }
        if (min < baseMin) {
          max += baseMin - min;
          min = baseMin;
        }
        if (max > baseMax) {
          min -= max - baseMax;
          max = baseMax;
        }
        if (min < baseMin) min = baseMin;
        if (max > baseMax) max = baseMax;
        viewState[chartKey][rangeKey] = { min, max };
        return { min, max };
      };

      const renderPerformance = (key) => {
        if (!perfContainer) return;
        const range = chartData.performance?.ranges?.[key];
        const svg = perfContainer.querySelector('[data-chart-canvas="performance"]');
        const empty = perfContainer.querySelector('[data-chart-empty="performance"]');
        const meta = perfContainer.querySelector('[data-chart-meta="performance"]');
        if (!range || !Array.isArray(range.pnl_jpy) || range.pnl_jpy.length < 2) {
          if (svg) svg.innerHTML = "";
          if (empty) empty.style.display = "flex";
          if (meta) meta.textContent = "データなし";
          return;
        }
        if (empty) empty.style.display = "none";
        const width = svg.clientWidth || 640;
        const height = svg.clientHeight || 280;
        svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
        const pad = { l: 42, r: 16, t: 18, b: 26 };
        const innerW = Math.max(10, width - pad.l - pad.r);
        const innerH = Math.max(10, height - pad.t - pad.b);

        const tsVals = range.pnl_jpy.map((row) => row[0]);
        const yVals = range.pnl_jpy.map((row) => row[1]);
        const minTs = Math.min(...tsVals);
        const maxTs = Math.max(...tsVals);
        let minY = Math.min(...yVals);
        let maxY = Math.max(...yVals);
        if (minY === maxY) {
          minY -= 1;
          maxY += 1;
        }
        const view = getOrInitView("performance", key, minTs, maxTs, minTs, maxTs);
        const tsSpan = Math.max(1, view.max - view.min);
        const ySpan = Math.max(1, maxY - minY);
        const xFor = (ts) => pad.l + ((ts - view.min) / tsSpan) * innerW;
        const yFor = (val) => pad.t + ((maxY - val) / ySpan) * innerH;

        let path = "";
        let started = false;
        range.pnl_jpy.forEach((row) => {
          if (row[0] < view.min || row[0] > view.max) return;
          const x = xFor(row[0]);
          const y = yFor(row[1]);
          path += `${started ? "L" : "M"}${x.toFixed(2)} ${y.toFixed(2)} `;
          started = true;
        });

        let grid = "";
        const gridCount = 4;
        for (let i = 0; i <= gridCount; i += 1) {
          const y = pad.t + (innerH * i) / gridCount;
          grid += `<line x1="${pad.l}" x2="${width - pad.r}" y1="${y}" y2="${y}" stroke="rgba(148,163,184,0.35)" stroke-dasharray="4 6"/>`;
        }
        const zeroLineY = (0 >= minY && 0 <= maxY) ? yFor(0) : null;
        let zeroLine = "";
        if (zeroLineY !== null) {
          zeroLine = `<line x1="${pad.l}" x2="${width - pad.r}" y1="${zeroLineY}" y2="${zeroLineY}" stroke="rgba(15,118,110,0.5)" stroke-width="1"/>`;
        }

        const last = range.pnl_jpy[range.pnl_jpy.length - 1];
        const lastPips = Array.isArray(range.pnl_pips) && range.pnl_pips.length
          ? range.pnl_pips[range.pnl_pips.length - 1][1]
          : null;
        const lastY = last[1];
        const lastX = xFor(last[0]);
        const lastYPos = yFor(lastY);
        const labelKey = range.label || key;
        const label = `${labelKey} / trades ${range.trades ?? 0} / ${lastY >= 0 ? "+" : ""}${lastY.toFixed(0)}円` +
          (lastPips !== null ? ` / ${lastPips >= 0 ? "+" : ""}${Number(lastPips).toFixed(1)}p` : "");
        if (meta) meta.textContent = label;

        svg.innerHTML = `
          <defs>
            <linearGradient id="perfLine" x1="0" y1="0" x2="1" y2="0">
              <stop offset="0%" stop-color="#0f766e" />
              <stop offset="100%" stop-color="#2563eb" />
            </linearGradient>
          </defs>
          ${grid}
          ${zeroLine}
          <path d="${path}" fill="none" stroke="url(#perfLine)" stroke-width="2.2" />
          <circle cx="${lastX}" cy="${lastYPos}" r="4" fill="#0f766e" stroke="#fff" stroke-width="1"/>
        `;

        if (svg) {
          svg.dataset.rangeKey = key;
          svg.style.touchAction = "none";
          if (!svg.dataset.zoomBound) {
            svg.dataset.zoomBound = "1";
            const dragState = { active: false, startX: 0, startRange: null, key: null };
            const getRangeInfo = () => {
              const currentKey = svg.dataset.rangeKey;
              const currentRange = chartData.performance?.ranges?.[currentKey];
              if (!currentRange || !Array.isArray(currentRange.pnl_jpy) || currentRange.pnl_jpy.length < 2) {
                return null;
              }
              const tsVals = currentRange.pnl_jpy.map((row) => row[0]);
              const min = Math.min(...tsVals);
              const max = Math.max(...tsVals);
              return { key: currentKey, min, max };
            };
            svg.addEventListener("wheel", (event) => {
              const info = getRangeInfo();
              if (!info) return;
              event.preventDefault();
              const width = svg.clientWidth || 640;
              const localPad = { l: 42, r: 16, t: 18, b: 26 };
              const inner = Math.max(10, width - localPad.l - localPad.r);
              const rect = svg.getBoundingClientRect();
              const x = event.clientX - rect.left;
              const xRatio = clamp((x - localPad.l) / inner, 0, 1);
              const current = getOrInitView("performance", info.key, info.min, info.max, info.min, info.max);
              const span = current.max - current.min;
              const baseSpan = Math.max(1, info.max - info.min);
              let minSpan = Math.max(baseSpan / 200, 60000);
              minSpan = Math.min(minSpan, baseSpan);
              const zoom = Math.exp(-event.deltaY * 0.0012);
              let newSpan = clamp(span / zoom, minSpan, baseSpan);
              const center = current.min + xRatio * span;
              let newMin = center - (center - current.min) * (newSpan / span);
              let newMax = newMin + newSpan;
              if (newMin < info.min) {
                newMax += info.min - newMin;
                newMin = info.min;
              }
              if (newMax > info.max) {
                newMin -= newMax - info.max;
                newMax = info.max;
              }
              viewState.performance[info.key] = { min: newMin, max: newMax };
              renderPerformance(info.key);
            }, { passive: false });
            svg.addEventListener("pointerdown", (event) => {
              const info = getRangeInfo();
              if (!info) return;
              dragState.active = true;
              dragState.startX = event.clientX;
              dragState.startRange = getOrInitView("performance", info.key, info.min, info.max, info.min, info.max);
              dragState.key = info.key;
              svg.setPointerCapture(event.pointerId);
            });
            svg.addEventListener("pointermove", (event) => {
              if (!dragState.active || !dragState.startRange || !dragState.key) return;
              const info = getRangeInfo();
              if (!info) return;
              const width = svg.clientWidth || 640;
              const localPad = { l: 42, r: 16, t: 18, b: 26 };
              const inner = Math.max(10, width - localPad.l - localPad.r);
              const deltaX = event.clientX - dragState.startX;
              const span = dragState.startRange.max - dragState.startRange.min;
              const shift = -(deltaX / inner) * span;
              let newMin = dragState.startRange.min + shift;
              let newMax = dragState.startRange.max + shift;
              if (newMin < info.min) {
                newMax += info.min - newMin;
                newMin = info.min;
              }
              if (newMax > info.max) {
                newMin -= newMax - info.max;
                newMax = info.max;
              }
              viewState.performance[dragState.key] = { min: newMin, max: newMax };
              renderPerformance(dragState.key);
            });
            const endDrag = (event) => {
              dragState.active = false;
              dragState.startRange = null;
              dragState.key = null;
              try {
                svg.releasePointerCapture(event.pointerId);
              } catch (err) {
                // ignore
              }
            };
            svg.addEventListener("pointerup", endDrag);
            svg.addEventListener("pointerleave", endDrag);
            svg.addEventListener("dblclick", () => {
              const info = getRangeInfo();
              if (!info) return;
              viewState.performance[info.key] = { min: info.min, max: info.max };
              renderPerformance(info.key);
            });
          }
        }
      };

      const buildMarkerTooltip = (marker) => {
        if (!marker) return "";
        const kind = marker.kind ? String(marker.kind).toUpperCase() : "ENTRY";
        const side = marker.side ? String(marker.side).toUpperCase() : "-";
        const pocket = marker.pocket || "-";
        const worker = marker.worker || "-";
        const strategy = marker.strategy || "-";
        const price = typeof marker.price === "number" ? marker.price.toFixed(3) : "-";
        const units = typeof marker.units_abs === "number" ? marker.units_abs.toLocaleString() : "-";
        const lines = [
          `${kind} ${side} / ${pocket}`,
          `worker: ${worker}`,
          `strategy: ${strategy}`,
          `${formatTs(marker.ts_ms)} @ ${price}`,
          `units: ${units}`,
        ];
        return lines.join("\n");
      };

      const renderPrice = (key) => {
        if (!priceContainer) return;
        const range = chartData.price?.ranges?.[key];
        const svg = priceContainer.querySelector('[data-chart-canvas="price"]');
        const empty = priceContainer.querySelector('[data-chart-empty="price"]');
        const meta = priceContainer.querySelector('[data-chart-meta="price"]');
        const tooltip = priceContainer.querySelector('[data-chart-tooltip="price"]');
        const wrap = priceContainer.querySelector(".chart-wrap");
        if (!range || !Array.isArray(range.candles) || range.candles.length < 2) {
          if (svg) svg.innerHTML = "";
          if (empty) empty.style.display = "flex";
          if (meta) meta.textContent = "データなし";
          if (tooltip) {
            tooltip.classList.remove("is-visible");
            tooltip.style.transform = "translate(-9999px, -9999px)";
          }
          return;
        }
        if (empty) empty.style.display = "none";
        const width = svg.clientWidth || 640;
        const height = svg.clientHeight || 280;
        svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
        const pad = { l: 40, r: 16, t: 18, b: 26 };
        const innerW = Math.max(10, width - pad.l - pad.r);
        const innerH = Math.max(10, height - pad.t - pad.b);

        const times = range.candles.map((row) => row[0]);
        const highs = range.candles.map((row) => row[2]);
        const lows = range.candles.map((row) => row[3]);
        const minTs = Math.min(...times);
        const maxTs = Math.max(...times);
        const candleCount = range.candles.length;
        const targetCount = 20;
        let defaultMin = minTs;
        let defaultMax = maxTs;
        const baseSpan = Math.max(1, maxTs - minTs);
        if (candleCount > 0 && candleCount < targetCount) {
          const paddedSpan = baseSpan * (targetCount / candleCount);
          const padSpan = (paddedSpan - baseSpan) / 2;
          defaultMin -= padSpan;
          defaultMax += padSpan;
        }
        let minY = Math.min(...lows);
        let maxY = Math.max(...highs);
        if (minY === maxY) {
          minY -= 0.5;
          maxY += 0.5;
        }
        const view = getOrInitView("price", key, minTs, maxTs, defaultMin, defaultMax);
        const tsSpan = Math.max(1, view.max - view.min);
        const ySpan = Math.max(1e-6, maxY - minY);
        const xFor = (ts) => pad.l + ((ts - view.min) / tsSpan) * innerW;
        const yFor = (val) => pad.t + ((maxY - val) / ySpan) * innerH;

        const visibleCandles = range.candles.filter((row) => row[0] >= view.min && row[0] <= view.max);
        const candleSpacing = innerW / Math.max(1, visibleCandles.length);
        const bodyWidth = clamp(candleSpacing * 0.6, 1.5, 7.5);

        let grid = "";
        for (let i = 0; i <= 4; i += 1) {
          const y = pad.t + (innerH * i) / 4;
          grid += `<line x1="${pad.l}" x2="${width - pad.r}" y1="${y}" y2="${y}" stroke="rgba(148,163,184,0.3)" stroke-dasharray="4 6"/>`;
        }

        let candlesSvg = "";
        visibleCandles.forEach((row) => {
          const x = xFor(row[0]);
          const open = row[1];
          const high = row[2];
          const low = row[3];
          const close = row[4];
          const isUp = close >= open;
          const color = isUp ? "#16a34a" : "#dc2626";
          const yOpen = yFor(open);
          const yClose = yFor(close);
          const yHigh = yFor(high);
          const yLow = yFor(low);
          const bodyTop = Math.min(yOpen, yClose);
          const bodyHeight = Math.max(1.5, Math.abs(yClose - yOpen));
          candlesSvg += `
            <line x1="${x}" x2="${x}" y1="${yHigh}" y2="${yLow}" stroke="${color}" stroke-width="1"/>
            <rect x="${x - bodyWidth / 2}" y="${bodyTop}" width="${bodyWidth}" height="${bodyHeight}" fill="${color}" rx="1" ry="1"/>
          `;
        });

        let markersSvg = "";
        const markers = Array.isArray(range.markers) ? range.markers : [];
        markers.forEach((m, idx) => {
          if (!m || typeof m.ts_ms !== "number" || typeof m.price !== "number") return;
          if (m.ts_ms < view.min || m.ts_ms > view.max) return;
          const x = xFor(m.ts_ms);
          const y = yFor(m.price);
          const isEntry = m.kind === "entry";
          const side = (m.side || "").toLowerCase();
          let sideColor = "#64748b";
          if (side === "long") sideColor = "#16a34a";
          if (side === "short") sideColor = "#dc2626";
          const size = 6;
          let shape = "";
          if (isEntry) {
            const points = `${x},${y - size} ${x - size},${y + size} ${x + size},${y + size}`;
            shape = `<polygon points="${points}" fill="${sideColor}" stroke="#ffffff" stroke-width="0.6"/>`;
          } else {
            const box = size * 0.85;
            shape = `<rect x="${(x - box).toFixed(2)}" y="${(y - box).toFixed(2)}" width="${(box * 2).toFixed(2)}" height="${(box * 2).toFixed(2)}" fill="rgba(255,255,255,0.95)" stroke="${sideColor}" stroke-width="1.2" rx="1.2" ry="1.2"/>`;
          }
          markersSvg += `
            <g class="chart-marker" data-marker-idx="${idx}">
              ${shape}
            </g>
          `;
        });

        const labelKey = range.label || key;
        const label = `${labelKey} / ${range.tf} / candles ${candleCount}` +
          (range.range_label ? ` / ${range.range_label}` : "");
        if (meta) meta.textContent = label;

        svg.innerHTML = `
          ${grid}
          ${candlesSvg}
          ${markersSvg}
        `;

        if (tooltip && wrap) {
          const showTooltip = (event, marker) => {
            const label = buildMarkerTooltip(marker);
            if (!label) return;
            tooltip.textContent = label;
            const rect = wrap.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            tooltip.classList.add("is-visible");
            const tooltipRect = tooltip.getBoundingClientRect();
            let left = x + 12;
            let top = y + 12;
            const maxLeft = rect.width - tooltipRect.width - 8;
            const maxTop = rect.height - tooltipRect.height - 8;
            if (left > maxLeft) left = Math.max(8, x - tooltipRect.width - 12);
            if (top > maxTop) top = Math.max(8, y - tooltipRect.height - 12);
            tooltip.style.transform = `translate(${left}px, ${top}px)`;
          };
          const hideTooltip = () => {
            tooltip.classList.remove("is-visible");
            tooltip.style.transform = "translate(-9999px, -9999px)";
          };
          svg.querySelectorAll(".chart-marker").forEach((el) => {
            const idx = parseInt(el.getAttribute("data-marker-idx") || "-1", 10);
            const marker = markers[idx];
            if (!marker) return;
            el.addEventListener("mouseenter", (event) => showTooltip(event, marker));
            el.addEventListener("mousemove", (event) => showTooltip(event, marker));
            el.addEventListener("mouseleave", hideTooltip);
          });
        }

        if (svg) {
          svg.dataset.rangeKey = key;
          svg.style.touchAction = "none";
          if (!svg.dataset.zoomBound) {
            svg.dataset.zoomBound = "1";
            const dragState = { active: false, startX: 0, startRange: null, key: null };
            const getRangeInfo = () => {
              const currentKey = svg.dataset.rangeKey;
              const currentRange = chartData.price?.ranges?.[currentKey];
              if (!currentRange || !Array.isArray(currentRange.candles) || currentRange.candles.length < 2) {
                return null;
              }
              const times = currentRange.candles.map((row) => row[0]);
              const min = Math.min(...times);
              const max = Math.max(...times);
              const candleLen = currentRange.candles.length;
              const targetLen = 20;
              let defaultMin = min;
              let defaultMax = max;
              const span = Math.max(1, max - min);
              if (candleLen > 0 && candleLen < targetLen) {
                const paddedSpan = span * (targetLen / candleLen);
                const padSpan = (paddedSpan - span) / 2;
                defaultMin -= padSpan;
                defaultMax += padSpan;
              }
              return { key: currentKey, min, max, defaultMin, defaultMax, span };
            };
            svg.addEventListener("wheel", (event) => {
              const info = getRangeInfo();
              if (!info) return;
              event.preventDefault();
              const width = svg.clientWidth || 640;
              const localPad = { l: 40, r: 16, t: 18, b: 26 };
              const inner = Math.max(10, width - localPad.l - localPad.r);
              const rect = svg.getBoundingClientRect();
              const x = event.clientX - rect.left;
              const xRatio = clamp((x - localPad.l) / inner, 0, 1);
              const current = getOrInitView("price", info.key, info.min, info.max, info.defaultMin, info.defaultMax);
              const viewSpan = current.max - current.min;
              let minSpan = Math.max(info.span / 200, 60000);
              minSpan = Math.min(minSpan, info.span);
              const zoom = Math.exp(-event.deltaY * 0.0012);
              let newSpan = clamp(viewSpan / zoom, minSpan, info.span);
              const center = current.min + xRatio * viewSpan;
              let newMin = center - (center - current.min) * (newSpan / viewSpan);
              let newMax = newMin + newSpan;
              if (newMin < info.min) {
                newMax += info.min - newMin;
                newMin = info.min;
              }
              if (newMax > info.max) {
                newMin -= newMax - info.max;
                newMax = info.max;
              }
              viewState.price[info.key] = { min: newMin, max: newMax };
              renderPrice(info.key);
            }, { passive: false });
            svg.addEventListener("pointerdown", (event) => {
              const info = getRangeInfo();
              if (!info) return;
              dragState.active = true;
              dragState.startX = event.clientX;
              dragState.startRange = getOrInitView("price", info.key, info.min, info.max, info.defaultMin, info.defaultMax);
              dragState.key = info.key;
              svg.setPointerCapture(event.pointerId);
            });
            svg.addEventListener("pointermove", (event) => {
              if (!dragState.active || !dragState.startRange || !dragState.key) return;
              const info = getRangeInfo();
              if (!info) return;
              const width = svg.clientWidth || 640;
              const localPad = { l: 40, r: 16, t: 18, b: 26 };
              const inner = Math.max(10, width - localPad.l - localPad.r);
              const deltaX = event.clientX - dragState.startX;
              const viewSpan = dragState.startRange.max - dragState.startRange.min;
              const shift = -(deltaX / inner) * viewSpan;
              let newMin = dragState.startRange.min + shift;
              let newMax = dragState.startRange.max + shift;
              if (newMin < info.min) {
                newMax += info.min - newMin;
                newMin = info.min;
              }
              if (newMax > info.max) {
                newMin -= newMax - info.max;
                newMax = info.max;
              }
              viewState.price[dragState.key] = { min: newMin, max: newMax };
              renderPrice(dragState.key);
            });
            const endDrag = (event) => {
              dragState.active = false;
              dragState.startRange = null;
              dragState.key = null;
              try {
                svg.releasePointerCapture(event.pointerId);
              } catch (err) {
                // ignore
              }
            };
            svg.addEventListener("pointerup", endDrag);
            svg.addEventListener("pointerleave", endDrag);
            svg.addEventListener("dblclick", () => {
              const info = getRangeInfo();
              if (!info) return;
              viewState.price[info.key] = { min: info.defaultMin, max: info.defaultMax };
              renderPrice(info.key);
            });
          }
        }

        const markerBody = priceContainer.querySelector('[data-chart-markers-body="price"]');
        const markerEmpty = priceContainer.querySelector('[data-chart-markers-empty="price"]');
        if (markerBody) {
          const entryMarkers = markers.filter((m) => m && m.kind === "entry");
          if (!entryMarkers.length) {
            markerBody.innerHTML = "";
            if (markerEmpty) markerEmpty.style.display = "block";
          } else {
            const rows = entryMarkers.map((m) => {
              const side = m.side ? String(m.side).toUpperCase() : "-";
              const pocket = m.pocket || "-";
              const worker = m.worker || "-";
              const strategy = m.strategy || "-";
              const units = typeof m.units_abs === "number" ? m.units_abs.toLocaleString() : "-";
              const price = typeof m.price === "number" ? m.price.toFixed(3) : "-";
              return `
                <tr>
                  <td class="mono nowrap">${escapeHtml(formatTs(m.ts_ms))}</td>
                  <td>${escapeHtml(side)}</td>
                  <td>${escapeHtml(pocket)}</td>
                  <td class="mono nowrap">${escapeHtml(worker)}</td>
                  <td>${escapeHtml(strategy)}</td>
                  <td class="mono">${escapeHtml(units)}</td>
                  <td class="mono">${escapeHtml(price)}</td>
                </tr>
              `;
            });
            markerBody.innerHTML = rows.join("");
            if (markerEmpty) markerEmpty.style.display = "none";
          }
        }
      };

      const bindRange = (container, renderFn, storageKey, defaultKey) => {
        if (!container) return;
        const buttons = Array.from(container.querySelectorAll(".range-button"));
        if (!buttons.length) return;
        const saved = sessionStorage.getItem(storageKey);
        const initial = saved && buttons.some((btn) => btn.dataset.range === saved)
          ? saved
          : defaultKey || buttons[0].dataset.range;
        setActiveButton(container, initial);
        renderFn(initial);
        buttons.forEach((btn) => {
          btn.addEventListener("click", () => {
            const key = btn.dataset.range;
            if (!key) return;
            sessionStorage.setItem(storageKey, key);
            setActiveButton(container, key);
            renderFn(key);
          });
        });
      };

      bindRange(
        perfContainer,
        renderPerformance,
        "qr_chart_range_perf",
        chartData.performance?.default_range || "1d"
      );
      bindRange(
        priceContainer,
        renderPrice,
        "qr_chart_range_price",
        chartData.price?.default_range || "1d"
      );

      const chartTabButtons = document.querySelectorAll('[data-chart-tabs] [data-tab-button]');
      chartTabButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const target = btn.dataset.tabTarget;
          if (!target) return;
          sessionStorage.setItem("qr_chart_mode", target);
        });
      });
      const chartMode = sessionStorage.getItem("qr_chart_mode");
      if (chartMode) {
        const chartTab = document.querySelector('[data-chart-tabs] [data-tab-button][data-tab-target="' + chartMode + '"]');
        if (chartTab) {
          chartTab.click();
        }
      }

      if (window.__qrDashboardResizeHandler) {
        window.removeEventListener("resize", window.__qrDashboardResizeHandler);
        window.__qrDashboardResizeHandler = null;
      }
      const resizeHandler = () => {
        const perfActive = document.querySelector("[data-chart='performance'] .range-button.is-active");
        if (perfActive) renderPerformance(perfActive.dataset.range);
        const priceActive = document.querySelector("[data-chart='price'] .range-button.is-active");
        if (priceActive) renderPrice(priceActive.dataset.range);
      };
      window.__qrDashboardResizeHandler = resizeHandler;
      window.addEventListener("resize", resizeHandler);
    })();
  </script>
{% endblock %}
