{% extends "base.html" %}
{% block content %}
  <div class="card">
    <h2>Operations Dashboard</h2>
    {% if dashboard.available %}
      {% if dashboard.generated_label %}
        <p class="stat-sub">最終更新: {{ dashboard.generated_label }}</p>
      {% endif %}
    {% else %}
      <p class="stat-sub warning">
        リアルタイムスナップショットを取得できませんでした{% if dashboard.error %}: {{ dashboard.error }}{% endif %}。
        GCS の設定と `run_sync_pipeline.py` の動作を確認してください。
      </p>
    {% endif %}
    <div class="stats-grid">
      {% set daily_class = 'stat-positive' if dashboard.performance.daily_pl_pips >= 0 else 'stat-negative' %}
      <div class="stat-card">
        <div class="stat-label">Daily P/L</div>
        <div class="stat-value {{ daily_class }}">{{ "%+.1f"|format(dashboard.performance.daily_pl_pips) }}p</div>
        <div class="stat-sub">{{ "%+.0f"|format(dashboard.performance.daily_pl_jpy) }} 円</div>
        <div class="stat-sub">1L eq {{ "%+.1f"|format(dashboard.performance.daily_pl_eq1l) }}p</div>
      </div>
      {% set weekly_class = 'stat-positive' if dashboard.performance.weekly_pl_pips >= 0 else 'stat-negative' %}
      <div class="stat-card">
        <div class="stat-label">Weekly P/L</div>
        <div class="stat-value {{ weekly_class }}">{{ "%+.1f"|format(dashboard.performance.weekly_pl_pips) }}p</div>
        <div class="stat-sub">{{ "%+.0f"|format(dashboard.performance.weekly_pl_jpy) }} 円</div>
        <div class="stat-sub">1L eq {{ "%+.1f"|format(dashboard.performance.weekly_pl_eq1l) }}p</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Win Rate</div>
        {% if dashboard.performance.recent_closed %}
          <div class="stat-value">{{ "%.1f"|format(dashboard.performance.win_rate_percent) }}%</div>
          <div class="stat-sub">{{ dashboard.performance.wins }} 勝 / {{ dashboard.performance.losses }} 敗</div>
        {% else %}
          <div class="stat-value">-</div>
          <div class="stat-sub">十分な検証データがありません</div>
        {% endif %}
      </div>
      <div class="stat-card">
        <div class="stat-label">Closed trades (7d)</div>
        <div class="stat-value">{{ dashboard.performance.recent_closed }}</div>
        <div class="stat-sub">累積 {{ dashboard.performance.total_trades }} 件</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Open positions</div>
        <div class="stat-value">{{ dashboard.performance.open_positions }}</div>
        <div class="stat-sub">Net units {{ "%+.0f"|format(dashboard.performance.net_units) }}</div>
        <div class="stat-sub">未実現 {{ "%+.1f"|format(dashboard.performance.unrealized_pl_pips) }}p / {{ "%+.0f"|format(dashboard.performance.unrealized_pl_jpy) }} 円（上段は確定損益）</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">New trades (snapshot)</div>
        <div class="stat-value">{{ dashboard.performance.new_trades }}</div>
        <div class="stat-sub">last trade {{ dashboard.performance.last_trade_at or '-' }}</div>
      </div>
    </div>

    <div class="section-title">オープンポジション</div>
    {% if dashboard.open_summary.pockets %}
      <table>
        <thead>
          <tr>
            <th>Pocket</th>
            <th>Direction</th>
            <th>Units</th>
            <th>Avg Price</th>
            <th>Unrealized (pips)</th>
            <th>Unrealized (JPY)</th>
            <th>Positions</th>
          </tr>
        </thead>
        <tbody>
        {% for row in dashboard.open_summary.pockets %}
          {% set pill_class = 'pill gain' if row.unrealized_pips > 0 else 'pill loss' if row.unrealized_pips < 0 else 'pill neutral' %}
          <tr>
            <td>{{ row.pocket }}</td>
            <td>{{ row.direction }}</td>
            <td>{{ "{:,}".format(row.units_abs) }}</td>
            <td>{{ "%.3f"|format(row.avg_price) }}</td>
            <td><span class="{{ pill_class }}">{{ "%+.2f"|format(row.unrealized_pips) }}p</span></td>
            <td>{{ "%+.0f"|format(row.unrealized_jpy) }}</td>
            <td>{{ row.trades }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="tagline">現在オープンポジションはありません。</p>
    {% endif %}

    <div class="section-title">トレードハイライト</div>

    <h3 class="section-subtitle">トップ勝ち／負け</h3>
    {% if dashboard.highlights_top %}
      <table>
        <thead>
          <tr>
            <th>Ticket</th>
            <th>Pocket</th>
            <th>P/L (pips)</th>
            <th>P/L (JPY)</th>
            <th>Closed</th>
          </tr>
        </thead>
        <tbody>
        {% for row in dashboard.highlights_top %}
          {% set pill_class = 'pill gain' if row.kind == 'gain' else 'pill loss' %}
          <tr>
            <td>{{ row.ticket_id }}</td>
            <td>{{ row.pocket }}</td>
            <td><span class="{{ pill_class }}">{{ "%+.1f"|format(row.pl_pips) }}</span></td>
            <td>{{ "%+.0f"|format(row.pl_jpy) }}</td>
            <td>{{ row.closed_at or '-' }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="tagline">十分なトレード実績がありません。</p>
    {% endif %}

    <h3 class="section-subtitle">最新トレード</h3>
    {% if dashboard.highlights_recent %}
      <table>
        <thead>
          <tr>
            <th>Ticket</th>
            <th>Pocket</th>
            <th>P/L (pips)</th>
            <th>P/L (JPY)</th>
            <th>Closed</th>
          </tr>
        </thead>
        <tbody>
        {% for row in dashboard.highlights_recent %}
          {% set pill_class = 'pill gain' if row.kind == 'gain' else 'pill loss' if row.kind == 'loss' else 'pill neutral' %}
          <tr>
            <td>{{ row.ticket_id }}</td>
            <td>{{ row.pocket }}</td>
            <td><span class="{{ pill_class }}">{{ "%+.1f"|format(row.pl_pips) }}</span></td>
            <td>{{ "%+.0f"|format(row.pl_jpy) }}</td>
            <td>{{ row.closed_at or '-' }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="tagline">最新トレード情報がまだありません。</p>
    {% endif %}
  </div>
  <div class="card">
    <h2 class="section-title">エクスカージョン（毎時）</h2>
    <div class="tagline">最新の毎時レポート（直近12件は /excursion から一覧参照可能）</div>
    <div style="display:grid; grid-template-columns: 1fr; gap: 1rem;">
      <div class="stat-card" style="max-height:50vh; overflow:auto; white-space:pre; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:13px;">
        {{ excursion_content or 'レポートが見つかりません。' }}
      </div>
    </div>
  </div>
{% endblock %}
