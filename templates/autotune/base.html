<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>{{ title or "QuantRabbit Autotune" }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: light;
      --bg: #f3f5f2;
      --bg-soft: #edf1f7;
      --ink: #0f172a;
      --muted: #52606d;
      --accent: #0f766e;
      --accent-strong: #0ea5a4;
      --accent-warm: #f59e0b;
      --accent-cool: #2563eb;
      --danger: #dc2626;
      --success: #16a34a;
      --warning: #b45309;
      --card: #ffffff;
      --card-muted: #f8fafc;
      --border: rgba(148, 163, 184, 0.4);
      --shadow: 0 22px 60px -40px rgba(15, 23, 42, 0.45);
      --radius: 18px;
      --font-sans: "Space Grotesk", "Segoe UI", "Helvetica Neue", sans-serif;
      --font-mono: "IBM Plex Mono", "SFMono-Regular", Menlo, Consolas, monospace;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      min-height: 100vh;
      height: 100vh;
      height: 100dvh;
      font-family: var(--font-sans);
      line-height: 1.55;
      font-variant-numeric: tabular-nums;
      color: var(--ink);
      background:
        radial-gradient(1200px 400px at 10% -10%, rgba(14, 165, 164, 0.15) 0%, transparent 60%),
        radial-gradient(900px 420px at 95% -20%, rgba(245, 158, 11, 0.18) 0%, transparent 55%),
        linear-gradient(180deg, #f8f5ef 0%, #eef2f7 60%, #f8fafc 100%);
      position: relative;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(90deg, rgba(15, 23, 42, 0.04) 1px, transparent 1px),
        linear-gradient(0deg, rgba(15, 23, 42, 0.04) 1px, transparent 1px);
      background-size: 48px 48px;
      opacity: 0.4;
      pointer-events: none;
      z-index: 0;
    }
    header {
      position: sticky;
      top: 0;
      z-index: 10;
      color: #f8fafc;
      background: linear-gradient(120deg, #0f172a 0%, #1e293b 55%, #0f766e 100%);
      padding: 1.4rem 2.2rem 1.2rem;
      box-shadow: 0 20px 50px -35px rgba(15, 23, 42, 0.7);
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
    }
    header::after {
      content: "";
      display: block;
      margin-top: 1rem;
      height: 2px;
      background: linear-gradient(90deg, rgba(14, 165, 164, 0.9), rgba(245, 158, 11, 0.8), rgba(37, 99, 235, 0.8));
      opacity: 0.8;
    }
    .header-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1.25rem;
    }
    header h1 {
      margin: 0;
      font-size: 1.6rem;
      letter-spacing: 0.02em;
      font-weight: 700;
    }
    header .subtitle {
      margin-top: 0.3rem;
      color: rgba(226, 232, 240, 0.82);
      font-size: 0.9rem;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }
    nav {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      flex-wrap: wrap;
    }
    .nav-link {
      padding: 0.35rem 0.9rem;
      border-radius: 999px;
      font-weight: 600;
      color: rgba(226, 232, 240, 0.7);
      border: 1px solid transparent;
      transition: all 0.2s ease;
    }
    .nav-link:hover {
      color: #fff;
      border-color: rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.35);
      text-decoration: none;
    }
    .nav-link.active {
      color: #0f172a;
      background: #f8fafc;
      border-color: rgba(226, 232, 240, 0.7);
      box-shadow: 0 10px 24px -18px rgba(15, 23, 42, 0.6);
    }
    .tabs {
      margin-bottom: 1.6rem;
      position: relative;
      z-index: 2;
    }
    .tabs-bar {
      display: inline-flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      padding: 0.45rem;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.08);
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 18px 40px -36px rgba(15, 23, 42, 0.6);
    }
    .tab-button {
      appearance: none;
      border: none;
      padding: 0.45rem 1.1rem;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.86rem;
      letter-spacing: 0.02em;
      color: rgba(15, 23, 42, 0.7);
      background: transparent;
      border: 1px solid transparent;
      box-shadow: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .tab-button:hover {
      color: #0f172a;
      background: rgba(15, 118, 110, 0.12);
    }
    .tab-button.is-active {
      color: #0f172a;
      background: #ffffff;
      box-shadow: 0 12px 22px -18px rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.4);
    }
    .tab-meta {
      margin-top: 0.7rem;
      font-size: 0.9rem;
      color: #52606d;
    }
    body.tabs-ready [data-tab-panel] {
      display: none;
    }
    body.tabs-ready [data-tab-panel].is-active {
      display: block;
    }
    main {
      padding: 2.6rem 1.8rem 4rem;
      max-width: 1250px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
      flex: 1 1 auto;
      min-height: 0;
      width: 100%;
      overflow-y: auto;
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
    }
    h2, h3, h4 {
      margin-top: 0;
      font-weight: 700;
      letter-spacing: 0.01em;
      color: #0b1220;
    }
    a { color: var(--accent-cool); text-decoration: none; }
    a:hover { text-decoration: underline; }
    table { width: 100%; border-collapse: collapse; min-width: 720px; font-variant-numeric: tabular-nums; }
    th, td { padding: 0.75rem 0.9rem; border-bottom: 1px solid var(--border); text-align: left; }
    th {
      background: var(--card-muted);
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #475569;
      font-weight: 700;
    }
    tbody tr:nth-child(even) { background: rgba(148, 163, 184, 0.06); }
    tbody tr:hover { background: rgba(148, 163, 184, 0.12); }
    .table-wrap {
      background: var(--card);
      border-radius: 16px;
      border: 1px solid var(--border);
      overflow-x: auto;
      margin-top: 0.6rem;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .pending { background: rgba(14, 165, 164, 0.15); color: #0f766e; }
    .approved { background: rgba(22, 163, 74, 0.16); color: #166534; }
    .rejected { background: rgba(239, 68, 68, 0.16); color: #991b1b; }
    .score-high { background:#15803d; color:#fff; padding: 0.15rem 0.45rem; border-radius: 0.5rem; }
    .score-mid { background:#f59e0b; color:#111; padding: 0.15rem 0.45rem; border-radius: 0.5rem; }
    .score-low { background:#dc2626; color:#fff; padding: 0.15rem 0.45rem; border-radius: 0.5rem; }
    .pf-good { color:#047857; font-weight:700; }
    .pf-warn { color:#b45309; font-weight:700; }
    .pf-bad { color:#991b1b; font-weight:700; }
    form { margin: 0; }
    input, select, textarea {
      font-family: var(--font-sans);
      padding: 0.45rem 0.6rem;
      border-radius: 0.6rem;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: #fff;
      color: var(--ink);
      outline: none;
    }
    input:focus, select:focus, textarea:focus {
      border-color: rgba(14, 165, 164, 0.9);
      box-shadow: 0 0 0 3px rgba(14, 165, 164, 0.15);
    }
    textarea { width: 100%; min-height: 90px; }
    .input-wide { width: min(420px, 100%); }
    .input-full { width: 100%; }
    pre {
      background: #0b1220;
      color: #e2e8f0;
      padding: 1rem;
      border-radius: 14px;
      overflow: auto;
      font-family: var(--font-mono);
      font-size: 0.86rem;
    }
    .card {
      background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
      padding: 1.6rem;
      border-radius: var(--radius);
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: var(--shadow);
      margin-bottom: 1.7rem;
      position: relative;
    }
    .card::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(14, 165, 164, 0.85), rgba(245, 158, 11, 0.7));
    }
    .buttons { display: flex; gap: 0.75rem; flex-wrap: wrap; }
    button {
      padding: 0.6rem 1.3rem;
      border: none;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 700;
      letter-spacing: 0.01em;
      background: var(--accent);
      color: #fff;
      box-shadow: 0 10px 20px -15px rgba(15, 23, 42, 0.6);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    button:hover { transform: translateY(-1px); box-shadow: 0 16px 26px -20px rgba(15, 23, 42, 0.7); }
    button.approve { background: var(--success); }
    button.reject { background: var(--danger); }
    button.success { background: var(--success); }
    button.danger { background: var(--danger); }
    button.muted { background: #64748b; }
    .btn-ghost {
      padding: 0.4rem 1rem;
      background: rgba(15, 118, 110, 0.12);
      color: #0f172a;
      border: 1px solid rgba(15, 118, 110, 0.25);
      box-shadow: none;
      font-size: 0.82rem;
    }
    .btn-ghost:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 22px -18px rgba(15, 23, 42, 0.6);
    }
    .refresh-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.8rem;
      flex-wrap: wrap;
      margin-top: 0.8rem;
    }
    .status-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.8rem;
      flex-wrap: wrap;
      margin: 0.9rem 0 1.4rem;
      padding: 0.75rem 0.9rem;
      background: rgba(255, 255, 255, 0.78);
      border: 1px solid rgba(148, 163, 184, 0.4);
      border-radius: 16px;
      box-shadow: 0 16px 32px -28px rgba(15, 23, 42, 0.55);
    }
    .filter-row {
      display: flex;
      align-items: center;
      gap: 0.7rem;
      flex-wrap: wrap;
      padding: 0.65rem 0.85rem;
      background: rgba(255, 255, 255, 0.82);
      border: 1px solid rgba(148, 163, 184, 0.4);
      border-radius: 14px;
      margin: 0.8rem 0 1rem;
      box-shadow: 0 14px 28px -26px rgba(15, 23, 42, 0.55);
    }
    .filter-row .input-compact { max-width: 320px; }
    .filter-title { font-size: 0.8rem; letter-spacing: 0.08em; text-transform: uppercase; color: #475569; }
    .filter-count { font-size: 0.82rem; color: #64748b; }
    .status-left {
      display: flex;
      align-items: center;
      gap: 0.9rem;
      flex-wrap: wrap;
    }
    .status-actions {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .status-pills {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .status-pill {
      padding: 0.25rem 0.7rem;
      border-radius: 999px;
      font-size: 0.72rem;
      font-weight: 700;
      background: rgba(148, 163, 184, 0.2);
      color: #334155;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }
    .status-pill.ok {
      background: rgba(22, 163, 74, 0.18);
      color: #166534;
    }
    .status-pill.warn {
      background: rgba(245, 158, 11, 0.18);
      color: #92400e;
    }
    .status-pill.stale {
      background: rgba(239, 68, 68, 0.16);
      color: #991b1b;
    }
    .refresh-meta {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.8rem;
      color: #52606d;
      flex-wrap: wrap;
    }
    .refresh-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent-strong);
      box-shadow: 0 0 0 4px rgba(14, 165, 164, 0.18);
    }
    .refresh-status {
      font-family: var(--font-mono);
      font-size: 0.74rem;
      color: #64748b;
    }
    .field-grid { display: grid; gap: 0.6rem; }
    .field-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #64748b;
    }
    .input-compact { max-width: 240px; width: 100%; }
    .form-block {
      background: rgba(248, 250, 252, 0.75);
      border-radius: 14px;
      padding: 1rem;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }
    .toolbar { display:flex; gap:0.6rem; align-items:center; flex-wrap:wrap; margin-bottom:0.8rem; }
    .toolbar input, .toolbar select { min-width: 120px; }
    .actions { display:flex; gap:0.45rem; align-items:center; flex-wrap:wrap; }
    .actions form { margin:0; }
    .actions a.detail-link { color: var(--accent-cool); font-weight:600; }
    .summary-row td { background:#f8fafc; font-size:0.9rem; color:#475569; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 1rem; margin-top: 1rem; }
    .stat-card {
      background: linear-gradient(180deg, #f8fafc 0%, #ffffff 100%);
      padding: 1rem;
      border-radius: 0.9rem;
      border: 1px solid rgba(148, 163, 184, 0.22);
      box-shadow: inset 0 0 0 1px rgba(248, 250, 252, 0.7);
    }
    .stat-card.compact { padding: 0.85rem; }
    .stat-card.compact .stat-label { font-size: 0.68rem; letter-spacing: 0.14em; }
    .stat-card.compact .stat-value { font-size: 1.35rem; }
    .stat-label { font-size: 0.75rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.12em; }
    .stat-value { font-size: 1.7rem; font-weight: 700; color: #0f172a; margin-top: 0.3rem; }
    .stat-sub { font-size: 0.82rem; color: #52606d; margin-top: 0.3rem; }
    .stat-positive { color: #047857; }
    .stat-negative { color: #b91c1c; }
    .level-ok { color: #0f766e; }
    .level-warn { color: #b45309; }
    .level-bad { color: #b91c1c; }
    .level-neutral { color: #475569; }
    .section-title { margin-top: 1.8rem; margin-bottom: 0.8rem; font-size: 1.15rem; font-weight: 700; color: #0f172a; }
    .section-subtitle { margin-top: 1rem; margin-bottom: 0.5rem; font-size: 1rem; font-weight: 600; color: #1f2937; }
    .tagline { font-size: 0.9rem; color: #52606d; margin-bottom: 0.5rem; }
    .pill {
      display: inline-flex;
      align-items: center;
      padding: 0.2rem 0.65rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 700;
    }
    .pill.gain { background: rgba(22, 163, 74, 0.15); color: #166534; }
    .pill.loss { background: rgba(239, 68, 68, 0.15); color: #991b1b; }
    .pill.neutral { background: rgba(148, 163, 184, 0.2); color: #1f2937; }
    .pill.ok,
    .pill.level-ok { background: rgba(14, 165, 164, 0.15); color: #0f766e; }
    .pill.warn,
    .pill.level-warn { background: rgba(245, 158, 11, 0.18); color: #92400e; }
    .pill.bad,
    .pill.level-bad { background: rgba(239, 68, 68, 0.18); color: #991b1b; }
    .pill-row { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.6rem; }
    .warning { color: var(--warning); }
    .mono { font-family: var(--font-mono); font-size: 0.82rem; }
    .nowrap { white-space: nowrap; }
    .mono-block {
      max-height: 70vh;
      overflow: auto;
      white-space: pre;
      font-family: var(--font-mono);
      font-size: 0.82rem;
      background: #0b1220;
      color: #e2e8f0;
      border-radius: 14px;
      padding: 1rem;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }
    .mono-short { max-height: 50vh; }
    .scroll-panel { max-height: 70vh; overflow: auto; }
    .preline { white-space: pre-line; }
    .split {
      display: grid;
      grid-template-columns: 260px 1fr;
      gap: 1rem;
      align-items: start;
    }
    .split-equal {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
      align-items: start;
    }
    .list-clean { list-style: none; padding-left: 0; margin: 0; }
    .list-clean li { margin: 0.25rem 0; display: flex; justify-content: space-between; gap: 0.5rem; }
    .list-meta { color: #64748b; font-size: 0.78rem; }

    .chart-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: 0.8rem;
    }
    .chart-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.8rem;
      flex-wrap: wrap;
      margin: 0.8rem 0 0.6rem;
    }
    .range-buttons {
      display: inline-flex;
      gap: 0.4rem;
      flex-wrap: wrap;
    }
    .range-button {
      appearance: none;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(148, 163, 184, 0.12);
      color: #0f172a;
      padding: 0.35rem 0.8rem;
      border-radius: 999px;
      font-size: 0.78rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .range-button:hover {
      background: rgba(15, 118, 110, 0.12);
      border-color: rgba(15, 118, 110, 0.3);
    }
    .range-button.is-active {
      background: var(--accent);
      color: #fff;
      border-color: transparent;
      box-shadow: 0 10px 18px -16px rgba(15, 23, 42, 0.6);
    }
    .chart-wrap {
      position: relative;
      padding: 0.6rem;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #fff;
      overflow: hidden;
    }
    .chart-svg {
      width: 100%;
      height: 280px;
      display: block;
    }
    .chart-empty {
      position: absolute;
      inset: 0.6rem;
      border-radius: 12px;
      background: rgba(248, 250, 252, 0.88);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .chart-meta {
      font-size: 0.8rem;
      color: #52606d;
      font-family: var(--font-mono);
    }
    .chart-markers { margin-top: 1rem; }
    .chart-marker-table { max-height: 260px; overflow: auto; }
    .chart-marker-table table { min-width: 680px; }
    .chart-svg .chart-marker { cursor: pointer; }
    .chart-legend {
      display: inline-flex;
      gap: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
      font-size: 0.72rem;
      color: #475569;
    }
    .legend-item { display: inline-flex; align-items: center; gap: 0.35rem; }
    .legend-shape {
      width: 10px;
      height: 10px;
      display: inline-block;
    }
    .legend-entry {
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-bottom: 10px solid #0f766e;
    }
    .legend-exit {
      width: 10px;
      height: 10px;
      border: 2px solid #0f766e;
      border-radius: 2px;
      background: #fff;
    }
    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      display: inline-block;
    }
    .legend-long { background: #16a34a; }
    .legend-short { background: #dc2626; }
    .chart-tooltip {
      position: absolute;
      top: 0;
      left: 0;
      transform: translate(-9999px, -9999px);
      background: rgba(15, 23, 42, 0.92);
      color: #f8fafc;
      font-size: 0.75rem;
      padding: 0.45rem 0.6rem;
      border-radius: 10px;
      box-shadow: 0 10px 22px -18px rgba(15, 23, 42, 0.6);
      max-width: 260px;
      white-space: pre-line;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.12s ease;
      z-index: 4;
    }
    .chart-tooltip.is-visible { opacity: 1; }

    main .card {
      /*
        Keep cards visible even if animations are paused/blocked in the browser.
        We only animate transform (no opacity fade-in).
      */
      opacity: 1;
      transform: translateY(12px);
      animation: cardIn 0.6s ease forwards;
    }
    .no-anim main .card {
      opacity: 1;
      transform: none;
      animation: none;
    }
    main .card:nth-of-type(1) { animation-delay: 0.06s; }
    main .card:nth-of-type(2) { animation-delay: 0.12s; }
    main .card:nth-of-type(3) { animation-delay: 0.18s; }
    main .card:nth-of-type(4) { animation-delay: 0.24s; }
    main .card:nth-of-type(5) { animation-delay: 0.3s; }
    main .card:nth-of-type(6) { animation-delay: 0.36s; }

    @keyframes cardIn {
      from { transform: translateY(12px); }
      to { transform: translateY(0); }
    }

    @media (max-width: 980px) {
      header { padding: 1.2rem 1.4rem 1rem; }
      main { padding: 2rem 1.1rem 3rem; }
      table { min-width: 640px; }
      .split { grid-template-columns: 1fr; }
      .split-equal { grid-template-columns: 1fr; }
      .input-compact { max-width: 100%; }
    }
    @media (max-width: 720px) {
      header::after { margin-top: 0.7rem; }
      header h1 { font-size: 1.35rem; }
      header .subtitle { font-size: 0.75rem; }
      .stat-value { font-size: 1.4rem; }
      table { min-width: 560px; }
      .tabs-bar { width: 100%; justify-content: center; }
      .tab-button { flex: 1 1 auto; text-align: center; }
      .chart-svg { height: 220px; }
    }
    @media (prefers-reduced-motion: reduce) {
      * { animation: none !important; transition: none !important; }
      main .card { opacity: 1; transform: none; }
    }
  </style>
  <script>
    (() => {
      try {
        if (sessionStorage.getItem("qr_refreshing") === "1") {
          document.documentElement.classList.add("no-anim");
          sessionStorage.removeItem("qr_refreshing");
        }
      } catch (err) {
        // ignore storage errors
      }
    })();
  </script>
</head>
<body>
  <header>
    <div class="header-inner">
      <div>
        <h1>QuantRabbit Console</h1>
        <div class="subtitle">運用と監視の統合ビュー</div>
      </div>
      <nav>
        <a href="/dashboard" class="nav-link {% if active_tab == 'dashboard' %}active{% endif %}">ダッシュボード</a>
      </nav>
    </div>
  </header>
  <main id="qr-main">
    {% block content %}{% endblock %}
  </main>
  <script>
    window.qrInitTabs = (() => {
      const init = () => {
        const containers = document.querySelectorAll("[data-tabs]");
        if (!containers.length) return;
        document.body.classList.add("tabs-ready");

        containers.forEach((container, index) => {
          const buttons = Array.from(container.querySelectorAll("[data-tab-button]")).filter(
            (button) => button.closest("[data-tabs]") === container
          );
          const panels = Array.from(container.querySelectorAll("[data-tab-panel]")).filter(
            (panel) => panel.closest("[data-tabs]") === container
          );
          const isLocal = container.hasAttribute("data-tabs-local");
          const persistDisabled = container.hasAttribute("data-tabs-no-persist");
          const keyBase = container.getAttribute("data-tabs-key") || container.getAttribute("id") || `tabs-${index}`;
          const storageKey = isLocal ? `qr_tabs_local_${keyBase}` : "qr_tabs_root";
          if (!buttons.length) return;

          const activateTab = (name, options = {}) => {
            const focus = options.focus ?? true;
            const updateUrl = options.updateUrl ?? true;

            buttons.forEach((button) => {
              const isActive = button.dataset.tabTarget === name;
              button.classList.toggle("is-active", isActive);
              button.setAttribute("aria-selected", isActive ? "true" : "false");
              button.tabIndex = isActive ? 0 : -1;
            });
            panels.forEach((panel) => {
              panel.classList.toggle("is-active", panel.dataset.tabPanel === name);
            });

            if (updateUrl && name) {
              const url = new URL(window.location.href);
              url.searchParams.set("tab", name);
              window.history.replaceState(null, "", url);
            }

            if (!persistDisabled && name) {
              try {
                sessionStorage.setItem(storageKey, name);
              } catch (err) {
                // ignore storage errors
              }
            }

            if (focus) {
              const target = buttons.find((button) => button.dataset.tabTarget === name);
              if (target) target.focus();
            }
          };

          buttons.forEach((button) => {
            button.addEventListener("click", () => {
              const name = button.dataset.tabTarget;
              if (name) activateTab(name, { updateUrl: !isLocal });
            });
            button.addEventListener("keydown", (event) => {
              if (!["ArrowLeft", "ArrowRight"].includes(event.key)) return;
              event.preventDefault();
              const currentIndex = buttons.indexOf(button);
              const delta = event.key === "ArrowRight" ? 1 : -1;
              const nextIndex = (currentIndex + delta + buttons.length) % buttons.length;
              const nextButton = buttons[nextIndex];
              if (nextButton?.dataset.tabTarget) {
                activateTab(nextButton.dataset.tabTarget, { updateUrl: !isLocal });
              }
            });
          });

          const urlParams = new URLSearchParams(window.location.search);
          const validTargets = new Set(
            buttons.map((button) => button.dataset.tabTarget).filter(Boolean)
          );
          let desired = null;
          if (isLocal) {
            if (!persistDisabled) {
              try {
                desired = sessionStorage.getItem(storageKey);
              } catch (err) {
                desired = null;
              }
            }
          } else {
            desired = urlParams.get("tab");
            if (desired && !validTargets.has(desired)) {
              const url = new URL(window.location.href);
              url.searchParams.delete("tab");
              window.history.replaceState(null, "", url);
              desired = null;
            }
            if (!desired) {
              try {
                const stored = sessionStorage.getItem(storageKey);
                if (stored && validTargets.has(stored)) desired = stored;
              } catch (err) {
                // ignore storage errors
              }
            }
          }
          const selected =
            buttons.find((button) => button.dataset.tabTarget === desired) ||
            buttons.find((button) => button.getAttribute("aria-selected") === "true") ||
            buttons[0];
          if (selected?.dataset.tabTarget) {
            activateTab(selected.dataset.tabTarget, {
              focus: false,
              updateUrl: false,
            });
          }
        });
      };
      return init;
    })();
    window.qrInitTabs();
  </script>
  <script>
    window.qrInitAutoRefresh = (() => {
      const state = {
        timerId: null,
        countdownId: null,
        refreshInFlight: false,
        visibilityBound: false,
      };

      const assignAnchors = () => {
        const cards = Array.from(document.querySelectorAll("main .card"));
        cards.forEach((card, idx) => {
          if (!card.dataset.scrollAnchor) {
            card.dataset.scrollAnchor = `card-${idx}`;
          }
        });
        const panels = Array.from(document.querySelectorAll("main [data-tab-panel]"));
        panels.forEach((panel) => {
          if (!panel.dataset.scrollAnchor && panel.id) {
            panel.dataset.scrollAnchor = `panel-${panel.id}`;
          }
        });
      };

      const isEditing = () => {
        const active = document.activeElement;
        if (!active) return false;
        const tag = active.tagName?.toLowerCase();
        return tag === "input" || tag === "textarea" || active.isContentEditable;
      };

      const getScrollContainer = () => document.getElementById("qr-main");

      const getScrollTop = () => {
        const container = getScrollContainer();
        if (container) return container.scrollTop || 0;
        return window.scrollY || 0;
      };

      const setScrollTop = (top) => {
        const container = getScrollContainer();
        if (container) {
          container.scrollTo({ top, behavior: "auto" });
          return;
        }
        window.scrollTo({ top, behavior: "auto" });
      };

      const buildRefreshUrl = () => {
        const url = new URL(window.location.href);
        const rootTabs = document.querySelector("[data-tabs]:not([data-tabs-local])");
        const activeTab = rootTabs?.querySelector("[data-tab-button].is-active")?.dataset?.tabTarget;
        if (activeTab) url.searchParams.set("tab", activeTab);
        url.searchParams.set("t", Date.now().toString());
        return url.toString();
      };

      const captureScrollState = () => {
        assignAnchors();
        let anchorKey = null;
        let anchorOffset = null;
        try {
          const sampleY = Math.min(window.innerHeight * 0.2, 180);
          const probe = document.elementFromPoint(32, sampleY);
          const anchor = probe?.closest("[data-scroll-anchor]");
          if (anchor?.dataset?.scrollAnchor) {
            anchorKey = anchor.dataset.scrollAnchor;
            anchorOffset = anchor.getBoundingClientRect().top;
          }
        } catch (err) {
          anchorKey = null;
        }
        const rootTabs = document.querySelector("[data-tabs]:not([data-tabs-local])");
        const activeTab = rootTabs?.querySelector("[data-tab-button].is-active")?.dataset?.tabTarget;
        const payload = {
          y: getScrollTop(),
          at: Date.now(),
          path: window.location.pathname,
          tab: activeTab || null,
          anchor: anchorKey,
          offset: anchorOffset,
        };
        try {
          sessionStorage.setItem("qr_scroll_state", JSON.stringify(payload));
        } catch (err) {
          // ignore storage errors
        }
        return payload;
      };

      const restoreScrollState = (payload) => {
        if (!payload) return;
        assignAnchors();
        const maxAgeMs = 120000;
        if (payload.at && Date.now() - payload.at > maxAgeMs) return;
        if (payload.path && payload.path !== window.location.pathname) return;
        if (payload.anchor) {
          const anchorEl = document.querySelector(`[data-scroll-anchor="${payload.anchor}"]`);
          if (anchorEl && typeof payload.offset === "number") {
            const currentTop = anchorEl.getBoundingClientRect().top;
            const delta = currentTop - payload.offset;
            setScrollTop(getScrollTop() + delta);
            return;
          }
        }
        if (typeof payload.y === "number") {
          setScrollTop(payload.y);
        }
      };

      const restoreScrollFromStorage = () => {
        const params = new URLSearchParams(window.location.search);
        if (!params.has("t")) return;
        try {
          const raw = sessionStorage.getItem("qr_scroll_state");
          if (!raw) return;
          const saved = JSON.parse(raw);
          if (!saved) return;
          window.requestAnimationFrame(() => {
            restoreScrollState(saved);
          });
        } catch (err) {
          // ignore parse errors
        }
      };

      const executeInlineScripts = (root) => {
        const scripts = Array.from(root.querySelectorAll("script"));
        scripts.forEach((script) => {
          const type = (script.getAttribute("type") || "").trim();
          if (type && type !== "text/javascript" && type !== "application/javascript") return;
          const code = script.textContent || "";
          if (!code.trim()) return;
          try {
            new Function(code)();
          } catch (err) {
            console.warn("qr inline script failed", err);
          }
        });
      };

      const applySwap = (newMain, scrollState) => {
        const oldMain = document.getElementById("qr-main") || document.querySelector("main");
        if (!oldMain) return;
        if (oldMain.id !== "qr-main") {
          oldMain.id = "qr-main";
        }
        oldMain.replaceWith(newMain);
        if (!newMain.id) newMain.id = "qr-main";
        executeInlineScripts(newMain);
        if (window.qrInitTabs) window.qrInitTabs();
        window.setTimeout(() => {
          if (window.qrInitAutoRefresh) window.qrInitAutoRefresh();
        }, 0);
        window.requestAnimationFrame(() => {
          restoreScrollState(scrollState);
        });
      };

      const softRefresh = async (url, scrollState) => {
        const resp = await fetch(url, {
          cache: "no-store",
          headers: {
            "X-QR-Refresh": "1",
            "Cache-Control": "no-store",
          },
        });
        if (!resp.ok) throw new Error(`refresh failed ${resp.status}`);
        const html = await resp.text();
        const doc = new DOMParser().parseFromString(html, "text/html");
        const newMain = doc.getElementById("qr-main") || doc.querySelector("main");
        if (!newMain) throw new Error("main missing");
        const title = doc.querySelector("title");
        if (title && title.textContent) {
          document.title = title.textContent;
        }
        if (document.startViewTransition) {
          await document.startViewTransition(() => {
            applySwap(newMain, scrollState);
          }).finished;
        } else {
          applySwap(newMain, scrollState);
        }
      };

      const init = () => {
        const refreshRoot = document.querySelector("[data-auto-refresh]");
        if (!refreshRoot) return;

        const intervalSec = parseInt(refreshRoot.dataset.autoRefreshSec || "15", 10);
        const mode = (refreshRoot.dataset.autoRefreshMode || "soft").toLowerCase();

        if (state.timerId) {
          clearTimeout(state.timerId);
          state.timerId = null;
        }
        if (state.countdownId) {
          clearInterval(state.countdownId);
          state.countdownId = null;
        }

        const updateCountdown = (statusEl, nextAt) => {
          if (!statusEl || !nextAt) return;
          const remaining = Math.max(0, Math.ceil((nextAt - Date.now()) / 1000));
          statusEl.textContent = `次の更新 ${remaining}s`;
        };

        const schedule = () => {
          const statusEl = refreshRoot.querySelector("[data-refresh-status]");
          const refreshButton = refreshRoot.querySelector("[data-refresh-now]");
          const nextAt = Date.now() + intervalSec * 1000;
          updateCountdown(statusEl, nextAt);

          if (refreshButton) {
            refreshButton.onclick = async () => {
              if (state.refreshInFlight) return;
              if (statusEl) statusEl.textContent = "更新中...";
              const scrollState = captureScrollState();
              const url = buildRefreshUrl();
              if (mode === "hard") {
                try {
                  sessionStorage.setItem("qr_refreshing", "1");
                } catch (err) {
                  // ignore storage errors
                }
                window.location.assign(url);
                return;
              }
              state.refreshInFlight = true;
              try {
                await softRefresh(url, scrollState);
              } catch (err) {
                try {
                  sessionStorage.setItem("qr_refreshing", "1");
                } catch (e) {
                  // ignore storage errors
                }
                window.location.assign(url);
              } finally {
                state.refreshInFlight = false;
              }
            };
          }

          state.timerId = window.setTimeout(async () => {
            if (document.hidden || isEditing()) {
              schedule();
              return;
            }
            if (statusEl) statusEl.textContent = "更新中...";
            const scrollState = captureScrollState();
            const url = buildRefreshUrl();
            if (mode === "hard") {
              try {
                sessionStorage.setItem("qr_refreshing", "1");
              } catch (err) {
                // ignore storage errors
              }
              window.location.assign(url);
              return;
            }
            state.refreshInFlight = true;
            try {
              await softRefresh(url, scrollState);
            } catch (err) {
              try {
                sessionStorage.setItem("qr_refreshing", "1");
              } catch (e) {
                // ignore storage errors
              }
              window.location.assign(url);
            } finally {
              state.refreshInFlight = false;
            }
          }, intervalSec * 1000);

          state.countdownId = window.setInterval(() => {
            updateCountdown(
              refreshRoot.querySelector("[data-refresh-status]"),
              nextAt
            );
          }, 1000);
        };

        restoreScrollFromStorage();
        schedule();

        if (!state.visibilityBound) {
          document.addEventListener("visibilitychange", () => {
            if (document.hidden) {
              if (state.timerId) clearTimeout(state.timerId);
            } else {
              schedule();
            }
          });
          state.visibilityBound = true;
        }
      };

      return init;
    })();
    window.qrInitAutoRefresh();
  </script>
</body>
</html>
