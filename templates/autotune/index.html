{% extends "base.html" %}
{% block content %}
  <div class="card">
    <h2>Autotune overview</h2>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total runs</div>
        <div class="stat-value">{{ stats.total or 0 }}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Pending</div>
        <div class="stat-value">{{ stats.pending or 0 }}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Approved</div>
        <div class="stat-value">{{ stats.approved or 0 }}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Rejected</div>
        <div class="stat-value">{{ stats.rejected or 0 }}</div>
      </div>
    </div>
    <div class="stat-sub" style="margin-top:1rem;">
      データソース: {{ "BigQuery" if using_bigquery else "SQLite" }}
      {% if stats.last_approved_at %}
        ・最終承認: {{ stats.last_approved_at }}
      {% endif %}
    </div>
  </div>

  <div class="card">
    <h2>Autotune control</h2>
    <p>現在の状態: <strong>{{ '有効' if settings.enabled else '停止中' }}</strong></p>
    <form method="post" action="/settings/autotune">
      <label>更新者</label>
      <input type="text" name="reviewer" value="" style="padding:0.4rem; width: 50%; margin-bottom:0.6rem;">
      {% if settings.enabled %}
        <button class="reject" type="submit" name="action" value="disable">オートチューニングを停止</button>
      {% else %}
        <button class="approve" type="submit" name="action" value="enable">オートチューニングを再開</button>
      {% endif %}
    </form>
    {% if settings.updated_at %}
      <p class="stat-sub">最終更新: {{ settings.updated_at }} / {{ settings.updated_by or 'システム' }}</p>
    {% endif %}
  </div>

  <div class="card">
    <h2>Pending approvals</h2>
    {% if pending %}
      <table>
        <thead>
          <tr>
            <th>Run ID</th>
            <th>Strategy</th>
            <th>Score</th>
            <th>PF</th>
            <th>Trades</th>
            <th>Max DD (pips)</th>
            <th>Created</th>
          </tr>
        </thead>
        <tbody>
        {% for run in pending %}
          <tr>
            <td><a href="/runs/{{ run.run_id }}/{{ run.strategy }}">{{ run.run_id }}</a></td>
            <td>{{ run.strategy }}</td>
            <td>{{ "%.4f"|format(run.score or 0) }}</td>
            <td>{{ "%.2f"|format(run.train.profit_factor) if run.train and run.train.profit_factor is not none else "-" }}</td>
            <td>{{ run.train.trades if run.train else "-" }}</td>
            <td>{{ run.train.max_dd_pips if run.train else "-" }}</td>
            <td>{{ run.created_at }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>No pending runs 🎉</p>
    {% endif %}
  </div>

  <div class="card">
    <h2>Recent activity</h2>
    {% if recent %}
      <table>
        <thead>
          <tr>
            <th>Run ID</th>
            <th>Strategy</th>
            <th>Status</th>
            <th>Score</th>
            <th>Updated</th>
          </tr>
        </thead>
        <tbody>
        {% for run in recent %}
          <tr>
            <td><a href="/runs/{{ run.run_id }}/{{ run.strategy }}">{{ run.run_id }}</a></td>
            <td>{{ run.strategy }}</td>
            <td><span class="badge {{ run.status }}">{{ run.status }}</span></td>
            <td>{{ "%.4f"|format(run.score or 0) }}</td>
            <td>{{ run.updated_at }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>No runs recorded yet.</p>
    {% endif %}
  </div>
{% endblock %}
