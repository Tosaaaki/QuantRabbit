{% extends "base.html" %}
{% block content %}
  <div class="card">
    <h2>é‹ç”¨ã‚µãƒãƒªãƒ¼</h2>
    {% if dashboard.available %}
      {% if dashboard.generated_label %}
        <p class="stat-sub">æœ€çµ‚æ›´æ–°: {{ dashboard.generated_label }}</p>
      {% endif %}
    {% else %}
      <p class="stat-sub warning">
        ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ{% if dashboard.error %}: {{ dashboard.error }}{% endif %}ã€‚
        GCS ã®è¨­å®šã¨ `run_sync_pipeline.py` ã®å‹•ä½œã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
      </p>
    {% endif %}
    <div class="stats-grid">
      {% set daily_class = 'stat-positive' if dashboard.performance.daily_pl_pips >= 0 else 'stat-negative' %}
      <div class="stat-card">
        <div class="stat-label">Daily P/L</div>
        <div class="stat-value {{ daily_class }}">{{ "%+.1f"|format(dashboard.performance.daily_pl_pips) }}p</div>
        <div class="stat-sub">{{ "%+.0f"|format(dashboard.performance.daily_pl_jpy) }} å††</div>
      </div>
      {% set weekly_class = 'stat-positive' if dashboard.performance.weekly_pl_pips >= 0 else 'stat-negative' %}
      <div class="stat-card">
        <div class="stat-label">Weekly P/L</div>
        <div class="stat-value {{ weekly_class }}">{{ "%+.1f"|format(dashboard.performance.weekly_pl_pips) }}p</div>
        <div class="stat-sub">{{ "%+.0f"|format(dashboard.performance.weekly_pl_jpy) }} å††</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Win Rate</div>
        {% if dashboard.performance.recent_closed %}
          <div class="stat-value">{{ "%.1f"|format(dashboard.performance.win_rate_percent) }}%</div>
          <div class="stat-sub">{{ dashboard.performance.wins }} å‹ / {{ dashboard.performance.losses }} æ•—</div>
        {% else %}
          <div class="stat-value">-</div>
          <div class="stat-sub">ååˆ†ãªæ¤œè¨¼ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
        {% endif %}
      </div>
      <div class="stat-card">
        <div class="stat-label">Closed trades (7d)</div>
        <div class="stat-value">{{ dashboard.performance.recent_closed }}</div>
        <div class="stat-sub">ç´¯ç© {{ dashboard.performance.total_trades }} ä»¶</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Open positions</div>
        <div class="stat-value">{{ dashboard.performance.open_positions }}</div>
        <div class="stat-sub">Net units {{ "%+.0f"|format(dashboard.performance.net_units) }}</div>
        <div class="stat-sub">æœªå®Ÿç¾ {{ "%+.1f"|format(dashboard.performance.unrealized_pl_pips) }}p / {{ "%+.0f"|format(dashboard.performance.unrealized_pl_jpy) }} å††ï¼ˆä¸Šæ®µã¯ç¢ºå®šæç›Šï¼‰</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">New trades (snapshot)</div>
        <div class="stat-value">{{ dashboard.performance.new_trades }}</div>
        <div class="stat-sub">last trade {{ dashboard.performance.last_trade_at or '-' }}</div>
      </div>
    </div>

    <div class="section-title">Autotune ã‚»ã‚¯ã‚·ãƒ§ãƒ³</div>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Pending</div>
        <div class="stat-value">{{ stats.pending or 0 }}</div>
        <div class="stat-sub">ç·ä»¶æ•° {{ stats.total or 0 }}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Approved</div>
        <div class="stat-value">{{ stats.approved or 0 }}</div>
        <div class="stat-sub">Rejected {{ stats.rejected or 0 }}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹</div>
        <div class="stat-value">{{ "BigQuery" if using_bigquery else "SQLite" }}</div>
        <div class="stat-sub">UI sync pipeline</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Autotune state</div>
        <div class="stat-value {{ 'stat-positive' if settings.enabled else 'stat-negative' }}">{{ 'ON' if settings.enabled else 'OFF' }}</div>
        <div class="stat-sub">
          {% if stats.last_approved_at %}
            æœ€çµ‚æ‰¿èª {{ stats.last_approved_at }}
          {% else %}
            æœ€çµ‚æ‰¿èªå±¥æ­´ãªã—
          {% endif %}
        </div>
      </div>
    </div>

    <div class="section-title">ã‚ªãƒ¼ãƒ—ãƒ³ãƒã‚¸ã‚·ãƒ§ãƒ³</div>
    {% if dashboard.open_summary.pockets %}
      <div class="table-wrap">
        <table>
        <thead>
          <tr>
            <th>Pocket</th>
            <th>æ–¹å‘</th>
            <th>æ•°é‡</th>
            <th>å¹³å‡ä¾¡æ ¼</th>
            <th>æœªå®Ÿç¾ (pips)</th>
            <th>æœªå®Ÿç¾ (JPY)</th>
            <th>å»ºç‰æ•°</th>
          </tr>
        </thead>
          <tbody>
          {% for row in dashboard.open_summary.pockets %}
            {% set pill_class = 'pill gain' if row.unrealized_pips > 0 else 'pill loss' if row.unrealized_pips < 0 else 'pill neutral' %}
            <tr>
              <td>{{ row.pocket }}</td>
              <td>{{ row.direction }}</td>
              <td>{{ "{:,}".format(row.units_abs) }}</td>
              <td>{{ "%.3f"|format(row.avg_price) }}</td>
              <td><span class="{{ pill_class }}">{{ "%+.2f"|format(row.unrealized_pips) }}p</span></td>
              <td>{{ "%+.0f"|format(row.unrealized_jpy) }}</td>
              <td>{{ row.trades }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="tagline">ç¾åœ¨ã‚ªãƒ¼ãƒ—ãƒ³ãƒã‚¸ã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    {% endif %}

    <div class="section-title">ãƒˆãƒ¬ãƒ¼ãƒ‰ãƒã‚¤ãƒ©ã‚¤ãƒˆ</div>

    <h3 class="section-subtitle">ãƒˆãƒƒãƒ—å‹ã¡ï¼è² ã‘</h3>
    {% if dashboard.highlights_top %}
      <div class="table-wrap">
        <table>
        <thead>
          <tr>
            <th>ãƒã‚±ãƒƒãƒˆ</th>
            <th>Pocket</th>
            <th>æç›Š (pips)</th>
            <th>æç›Š (JPY)</th>
            <th>æ±ºæ¸ˆæ™‚åˆ»</th>
          </tr>
        </thead>
          <tbody>
          {% for row in dashboard.highlights_top %}
            {% set pill_class = 'pill gain' if row.kind == 'gain' else 'pill loss' %}
            <tr>
              <td>{{ row.ticket_id }}</td>
              <td>{{ row.pocket }}</td>
              <td><span class="{{ pill_class }}">{{ "%+.1f"|format(row.pl_pips) }}</span></td>
              <td>{{ "%+.0f"|format(row.pl_jpy) }}</td>
              <td>{{ row.closed_at or '-' }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="tagline">ååˆ†ãªãƒˆãƒ¬ãƒ¼ãƒ‰å®Ÿç¸¾ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    {% endif %}

    <h3 class="section-subtitle">æœ€æ–°ãƒˆãƒ¬ãƒ¼ãƒ‰</h3>
    {% if dashboard.highlights_recent %}
      <div class="table-wrap">
        <table>
        <thead>
          <tr>
            <th>ãƒã‚±ãƒƒãƒˆ</th>
            <th>Pocket</th>
            <th>æç›Š (pips)</th>
            <th>æç›Š (JPY)</th>
            <th>æ±ºæ¸ˆæ™‚åˆ»</th>
          </tr>
        </thead>
          <tbody>
          {% for row in dashboard.highlights_recent %}
            {% set pill_class = 'pill gain' if row.kind == 'gain' else 'pill loss' if row.kind == 'loss' else 'pill neutral' %}
            <tr>
              <td>{{ row.ticket_id }}</td>
              <td>{{ row.pocket }}</td>
              <td><span class="{{ pill_class }}">{{ "%+.1f"|format(row.pl_pips) }}</span></td>
              <td>{{ "%+.0f"|format(row.pl_jpy) }}</td>
              <td>{{ row.closed_at or '-' }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="tagline">æœ€æ–°ãƒˆãƒ¬ãƒ¼ãƒ‰æƒ…å ±ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    {% endif %}
  </div>

  <div class="card">
    <h2>ã‚ªãƒ¼ãƒˆãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°åˆ¶å¾¡</h2>
    <p>ç¾åœ¨ã®çŠ¶æ…‹: <strong>{{ 'æœ‰åŠ¹' if settings.enabled else 'åœæ­¢ä¸­' }}</strong></p>
    <form method="post" action="/settings/autotune">
      <label>æ›´æ–°è€…</label>
      <input type="text" name="reviewer" value="" class="input-wide" style="margin-bottom:0.6rem;">
      {% if settings.enabled %}
        <button class="reject" type="submit" name="action" value="disable">ã‚ªãƒ¼ãƒˆãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’åœæ­¢</button>
      {% else %}
        <button class="approve" type="submit" name="action" value="enable">ã‚ªãƒ¼ãƒˆãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’å†é–‹</button>
      {% endif %}
    </form>
    {% if settings.updated_at %}
      <p class="stat-sub">æœ€çµ‚æ›´æ–°: {{ settings.updated_at }} / {{ settings.updated_by or 'ã‚·ã‚¹ãƒ†ãƒ ' }}</p>
    {% endif %}
  </div>

  <div class="card">
    <h2>æ‰¿èªå¾…ã¡</h2>
    {% if pending %}
      <div class="table-wrap">
        <table>
        <thead>
          <tr>
            <th>Run ID</th>
            <th>æˆ¦ç•¥</th>
            <th>ã‚¹ã‚³ã‚¢</th>
            <th>PF</th>
            <th>ä»¶æ•°</th>
            <th>æœ€å¤§DD (pips)</th>
            <th>ä½œæˆ</th>
          </tr>
        </thead>
          <tbody>
          {% for run in pending %}
            <tr>
              <td><a href="/runs/{{ run.run_id }}/{{ run.strategy }}">{{ run.run_id }}</a></td>
              <td>{{ run.strategy }}</td>
              <td>{{ "%.4f"|format(run.score or 0) }}</td>
              <td>{{ "%.2f"|format(run.train.profit_factor) if run.train and run.train.profit_factor is not none else "-" }}</td>
              <td>{{ run.train.trades if run.train else "-" }}</td>
              <td>{{ run.train.max_dd_pips if run.train else "-" }}</td>
              <td>{{ run.created_at }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p>No pending runs ğŸ‰</p>
    {% endif %}
  </div>

  <div class="card">
    <h2>æœ€è¿‘ã®æ›´æ–°</h2>
    {% if recent %}
      <div class="table-wrap">
        <table>
        <thead>
          <tr>
            <th>Run ID</th>
            <th>æˆ¦ç•¥</th>
            <th>çŠ¶æ…‹</th>
            <th>ã‚¹ã‚³ã‚¢</th>
            <th>æ›´æ–°</th>
          </tr>
        </thead>
          <tbody>
          {% for run in recent %}
            <tr>
              <td><a href="/runs/{{ run.run_id }}/{{ run.strategy }}">{{ run.run_id }}</a></td>
              <td>{{ run.strategy }}</td>
              <td><span class="badge {{ run.status }}">{{ run.status }}</span></td>
              <td>{{ "%.4f"|format(run.score or 0) }}</td>
              <td>{{ run.updated_at }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p>No runs recorded yet.</p>
    {% endif %}
  </div>
{% endblock %}
