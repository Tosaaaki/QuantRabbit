{% extends "base.html" %}
{% block content %}
  <div class="card">
    <h2>Operations Dashboard</h2>
    {% if dashboard.available %}
      {% if dashboard.generated_label %}
        <p class="stat-sub">æœ€çµ‚æ›´æ–°: {{ dashboard.generated_label }}</p>
      {% endif %}
    {% else %}
      <p class="stat-sub warning">
        ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ{% if dashboard.error %}: {{ dashboard.error }}{% endif %}ã€‚
        GCS ã®è¨­å®šã¨ `run_sync_pipeline.py` ã®å‹•ä½œã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
      </p>
    {% endif %}
    <div class="stats-grid">
      {% set daily_class = 'stat-positive' if dashboard.performance.daily_pl_pips >= 0 else 'stat-negative' %}
      <div class="stat-card">
        <div class="stat-label">Daily P/L</div>
        <div class="stat-value {{ daily_class }}">{{ "%+.1f"|format(dashboard.performance.daily_pl_pips) }}p</div>
        <div class="stat-sub">{{ "%+.0f"|format(dashboard.performance.daily_pl_jpy) }} å††</div>
      </div>
      {% set weekly_class = 'stat-positive' if dashboard.performance.weekly_pl_pips >= 0 else 'stat-negative' %}
      <div class="stat-card">
        <div class="stat-label">Weekly P/L</div>
        <div class="stat-value {{ weekly_class }}">{{ "%+.1f"|format(dashboard.performance.weekly_pl_pips) }}p</div>
        <div class="stat-sub">{{ "%+.0f"|format(dashboard.performance.weekly_pl_jpy) }} å††</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Win Rate</div>
        {% if dashboard.performance.recent_closed %}
          <div class="stat-value">{{ "%.1f"|format(dashboard.performance.win_rate_percent) }}%</div>
          <div class="stat-sub">{{ dashboard.performance.wins }} å‹ / {{ dashboard.performance.losses }} æ•—</div>
        {% else %}
          <div class="stat-value">-</div>
          <div class="stat-sub">ååˆ†ãªæ¤œè¨¼ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
        {% endif %}
      </div>
      <div class="stat-card">
        <div class="stat-label">Closed trades (7d)</div>
        <div class="stat-value">{{ dashboard.performance.recent_closed }}</div>
        <div class="stat-sub">ç´¯ç© {{ dashboard.performance.total_trades }} ä»¶</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Open positions</div>
        <div class="stat-value">{{ dashboard.performance.open_positions }}</div>
        <div class="stat-sub">Net units {{ "%+.0f"|format(dashboard.performance.net_units) }}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">New trades (snapshot)</div>
        <div class="stat-value">{{ dashboard.performance.new_trades }}</div>
        <div class="stat-sub">last trade {{ dashboard.performance.last_trade_at or '-' }}</div>
      </div>
    </div>

    <div class="section-title">Autotune ã‚»ã‚¯ã‚·ãƒ§ãƒ³</div>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Pending</div>
        <div class="stat-value">{{ stats.pending or 0 }}</div>
        <div class="stat-sub">ç·ä»¶æ•° {{ stats.total or 0 }}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Approved</div>
        <div class="stat-value">{{ stats.approved or 0 }}</div>
        <div class="stat-sub">Rejected {{ stats.rejected or 0 }}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹</div>
        <div class="stat-value">{{ "BigQuery" if using_bigquery else "SQLite" }}</div>
        <div class="stat-sub">UI sync pipeline</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Autotune state</div>
        <div class="stat-value {{ 'stat-positive' if settings.enabled else 'stat-negative' }}">{{ 'ON' if settings.enabled else 'OFF' }}</div>
        <div class="stat-sub">
          {% if stats.last_approved_at %}
            æœ€çµ‚æ‰¿èª {{ stats.last_approved_at }}
          {% else %}
            æœ€çµ‚æ‰¿èªå±¥æ­´ãªã—
          {% endif %}
        </div>
      </div>
    </div>

    <div class="section-title">ã‚ªãƒ¼ãƒ—ãƒ³ãƒã‚¸ã‚·ãƒ§ãƒ³</div>
    {% if dashboard.open_summary.pockets %}
      <table>
        <thead>
          <tr>
            <th>Pocket</th>
            <th>Net Units</th>
            <th>Long</th>
            <th>Short</th>
            <th>Avg Price</th>
            <th>Positions</th>
          </tr>
        </thead>
        <tbody>
        {% for row in dashboard.open_summary.pockets %}
          <tr>
            <td>{{ row.pocket }}</td>
            <td>{{ "%+.0f"|format(row.units) }}</td>
            <td>{{ "%+.0f"|format(row.long_units) }}</td>
            <td>{{ "%+.0f"|format(-row.short_units) }}</td>
            <td>{{ "%.3f"|format(row.avg_price) }}</td>
            <td>{{ row.trades }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="tagline">ç¾åœ¨ã‚ªãƒ¼ãƒ—ãƒ³ãƒã‚¸ã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    {% endif %}

    <div class="section-title">æœ€è¿‘ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ãƒã‚¤ãƒ©ã‚¤ãƒˆ</div>
    {% if dashboard.highlights %}
      <table>
        <thead>
          <tr>
            <th>Ticket</th>
            <th>Pocket</th>
            <th>P/L (pips)</th>
            <th>P/L (JPY)</th>
            <th>Closed</th>
          </tr>
        </thead>
        <tbody>
        {% for row in dashboard.highlights %}
          {% set pill_class = 'pill gain' if row.kind == 'gain' else 'pill loss' %}
          <tr>
            <td>{{ row.ticket_id }}</td>
            <td>{{ row.pocket }}</td>
            <td><span class="{{ pill_class }}">{{ "%+.1f"|format(row.pl_pips) }}</span></td>
            <td>{{ "%+.0f"|format(row.pl_jpy) }}</td>
            <td>{{ row.closed_at or '-' }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="tagline">è¡¨ç¤ºã§ãã‚‹ãƒˆãƒ¬ãƒ¼ãƒ‰ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    {% endif %}
  </div>

  <div class="card">
    <h2>Autotune control</h2>
    <p>ç¾åœ¨ã®çŠ¶æ…‹: <strong>{{ 'æœ‰åŠ¹' if settings.enabled else 'åœæ­¢ä¸­' }}</strong></p>
    <form method="post" action="/settings/autotune">
      <label>æ›´æ–°è€…</label>
      <input type="text" name="reviewer" value="" style="padding:0.4rem; width: 50%; margin-bottom:0.6rem;">
      {% if settings.enabled %}
        <button class="reject" type="submit" name="action" value="disable">ã‚ªãƒ¼ãƒˆãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’åœæ­¢</button>
      {% else %}
        <button class="approve" type="submit" name="action" value="enable">ã‚ªãƒ¼ãƒˆãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’å†é–‹</button>
      {% endif %}
    </form>
    {% if settings.updated_at %}
      <p class="stat-sub">æœ€çµ‚æ›´æ–°: {{ settings.updated_at }} / {{ settings.updated_by or 'ã‚·ã‚¹ãƒ†ãƒ ' }}</p>
    {% endif %}
  </div>

  <div class="card">
    <h2>Pending approvals</h2>
    {% if pending %}
      <table>
        <thead>
          <tr>
            <th>Run ID</th>
            <th>Strategy</th>
            <th>Score</th>
            <th>PF</th>
            <th>Trades</th>
            <th>Max DD (pips)</th>
            <th>Created</th>
          </tr>
        </thead>
        <tbody>
        {% for run in pending %}
          <tr>
            <td><a href="/runs/{{ run.run_id }}/{{ run.strategy }}">{{ run.run_id }}</a></td>
            <td>{{ run.strategy }}</td>
            <td>{{ "%.4f"|format(run.score or 0) }}</td>
            <td>{{ "%.2f"|format(run.train.profit_factor) if run.train and run.train.profit_factor is not none else "-" }}</td>
            <td>{{ run.train.trades if run.train else "-" }}</td>
            <td>{{ run.train.max_dd_pips if run.train else "-" }}</td>
            <td>{{ run.created_at }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>No pending runs ğŸ‰</p>
    {% endif %}
  </div>

  <div class="card">
    <h2>Recent activity</h2>
    {% if recent %}
      <table>
        <thead>
          <tr>
            <th>Run ID</th>
            <th>Strategy</th>
            <th>Status</th>
            <th>Score</th>
            <th>Updated</th>
          </tr>
        </thead>
        <tbody>
        {% for run in recent %}
          <tr>
            <td><a href="/runs/{{ run.run_id }}/{{ run.strategy }}">{{ run.run_id }}</a></td>
            <td>{{ run.strategy }}</td>
            <td><span class="badge {{ run.status }}">{{ run.status }}</span></td>
            <td>{{ "%.4f"|format(run.score or 0) }}</td>
            <td>{{ run.updated_at }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>No runs recorded yet.</p>
    {% endif %}
  </div>
{% endblock %}
