{% extends "base.html" %}
{% block content %}
  <div class="card">
    <h2>Autotune</h2>
    <div class="toolbar">
      <form method="get" action="/autotune" class="toolbar">
        <label>状態</label>
        <select name="status">
          {% for s in ['all','pending','approved','rejected'] %}
            <option value="{{s}}" {% if filters.status==s %}selected{% endif %}>{{ s }}</option>
          {% endfor %}
        </select>
        <label>並び</label>
        <select name="sort">
          {% for key,label in {'updated':'更新','score':'スコア','pf':'PF','trades':'件数','dd':'DD','wr':'勝率','created':'作成'}.items() %}
            <option value="{{key}}" {% if filters.sort==key %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
        <select name="order">
          <option value="desc" {% if filters.order=='desc' %}selected{% endif %}>降順</option>
          <option value="asc" {% if filters.order=='asc' %}selected{% endif %}>昇順</option>
        </select>
        <label>表示</label>
        <select name="page_size">
          {% for n in [25,50,100,150,200] %}
            <option value="{{n}}" {% if filters.page_size==n %}selected{% endif %}>{{n}}</option>
          {% endfor %}
        </select>
        <input type="text" name="q" placeholder="strategy/run id 検索" value="{{ filters.q }}">
        <button type="submit">適用</button>
      </form>
      <div class="stat-sub">{{ filters.total }} 件中 {{ (filters.page-1)*filters.page_size + 1 }} - {{ (filters.page-1)*filters.page_size + items|length }} を表示</div>
    </div>

    <div class="stats-grid" style="margin-top:0.5rem;">
      <div class="stat-card"><div class="stat-label">Total</div><div class="stat-value">{{ stats.total or 0 }}</div></div>
      <div class="stat-card"><div class="stat-label">Pending</div><div class="stat-value">{{ stats.pending or 0 }}</div></div>
      <div class="stat-card"><div class="stat-label">Approved</div><div class="stat-value">{{ stats.approved or 0 }}</div></div>
      <div class="stat-card"><div class="stat-label">Rejected</div><div class="stat-value">{{ stats.rejected or 0 }}</div></div>
    </div>
    <div class="stat-sub" style="margin-top:0.4rem;">
      データソース: {{ 'BigQuery' if using_bigquery else 'SQLite' }}
      {% if stats.last_approved_at %}・最終承認: {{ stats.last_approved_at }}{% endif %}
    </div>
  </div>

  <div class="card">
    <h2>Runs</h2>
    {% if items %}
      <table>
        <thead>
          <tr>
            <th>Run ID</th>
            <th>Strategy</th>
            <th>Status</th>
            <th>Score</th>
            <th>PF</th>
            <th>Trades</th>
            <th>Max DD</th>
            <th>Updated</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
        {% for r in items %}
          {% set score_class = 'score-high' if r._score>=1.4 else ('score-mid' if r._score>=1.1 else 'score-low') %}
          {% set pf_class = 'pf-good' if r._pf>=1.3 else ('pf-warn' if r._pf>=1.05 else 'pf-bad') %}
          <tr>
            <td><a class="detail-link" href="/runs/{{ r.run_id }}/{{ r.strategy }}">{{ r.run_id }}</a></td>
            <td>{{ r.strategy }}</td>
            <td><span class="badge {{ r.status }}">{{ r.status }}</span></td>
            <td><span class="{{ score_class }}">{{ '%.3f'|format(r._score) }}</span></td>
            <td class="{{ pf_class }}">{{ '%.2f'|format(r._pf) }}</td>
            <td>{{ r._trades }}</td>
            <td>{{ '%.1f'|format(r._dd) }}</td>
            <td>{{ r.updated_at or r.created_at }}</td>
            <td>
              <div class="actions">
                <a class="detail-link" href="/runs/{{ r.run_id }}/{{ r.strategy }}">詳細</a>
              </div>
            </td>
          </tr>
          <tr class="summary-row">
            <td colspan="9" class="stat-sub">{{ r._summary.replace('\n',' ') }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>

      <div class="toolbar" style="justify-content:space-between; margin-top:0.8rem;">
        <div class="stat-sub">ページ {{ filters.page }} / {{ filters.pages }}</div>
        <div>
          {% if filters.page>1 %}
            <a href="/autotune?status={{filters.status}}&sort={{filters.sort}}&order={{filters.order}}&q={{filters.q}}&page={{filters.page-1}}&page_size={{filters.page_size}}">前へ</a>
          {% endif %}
          {% if filters.page<filters.pages %}
            <a style="margin-left:0.6rem;" href="/autotune?status={{filters.status}}&sort={{filters.sort}}&order={{filters.order}}&q={{filters.q}}&page={{filters.page+1}}&page_size={{filters.page_size}}">次へ</a>
          {% endif %}
        </div>
      </div>
    {% else %}
      <p>No runs found.</p>
    {% endif %}
  </div>

  <div class="card">
    <h2>Autotune control</h2>
    <p>現在の状態: <strong>{{ '有効' if settings.enabled else '停止中' }}</strong></p>
    <form method="post" action="/settings/autotune">
      <label>更新者</label>
      <input type="text" name="reviewer" value="" style="padding:0.4rem; width: 50%; margin-bottom:0.6rem;">
      {% if settings.enabled %}
        <button class="reject" type="submit" name="action" value="disable">オートチューニングを停止</button>
      {% else %}
        <button class="approve" type="submit" name="action" value="enable">オートチューニングを再開</button>
      {% endif %}
    </form>
    {% if settings.updated_at %}
      <p class="stat-sub">最終更新: {{ settings.updated_at }} / {{ settings.updated_by or 'システム' }}</p>
    {% endif %}
  </div>
{% endblock %}
