# Strategy-specific BE trail / TP move overrides.
# Values are in pips and seconds.

defaults:
  apply_when_soft_tp: true
  neg_exit:
    enabled: true
    allow_reasons:
      - hard_stop
      - tech_hard_stop
      - tech_return_fail
      - tech_reversal_combo
      - tech_candle_reversal
      - tech_nwave_flip
      - rsi_fade
      - m1_rsi_fade
      - vwap_cut
      - m1_vwap_cut
      - atr_spike
      - m1_atr_spike
      - structure_break
      - m1_structure_break
      - reentry_reset
      - max_hold
      - max_adverse
      - lock_floor
      - time_stop
      - timeout
      - mtf_reversal
      - trend_failure
      - trend_exhaust
      - drawdown
      - max_drawdown
      - health_exit
      - hazard_exit
      - margin_health
      - free_margin_low
      - margin_usage_high
    deny_reasons: []
  min_profit_pips:
    macro: 1.6
    micro: 1.2
    scalp: 1.0
  min_profit_ratio:
    macro: 0.45
    micro: 0.25
    scalp: 0.28
  min_profit_ratio_min_tp_pips: 1.5
  min_profit_ratio_reasons:
    - partial_take
    - fast_cut_time
    - lock_floor
    - take_profit
    - range_timeout
    - time_stop
    - trail_take
    - lock_release
    - take_profit_zone
    - rsi_take
    - trail_lock
    - profit_lock
    - lock_trail
    - near_be
  end_reversal_exit:
    # Allow early profit-taking when trend exhaustion signs cluster (to catch small rebounds).
    enabled: true
    score_min: 0.58
    min_profit_pips: 0.2
    max_factor_age_sec: 150
    reasons:
      - take_profit
      - take_profit_zone
      - rsi_take
      - lock_floor
      - trail_take
      - trail_lock
      - profit_lock
      - lock_trail
      - near_be
      - range_timeout
      - candle_*
    # Score components are normalized in order_manager:
    # RSI extreme, MA gap compression, ADX cooldown, VWAP gap compression, M1-M5 gap slope.
    rsi_center: 35.0
    rsi_band: 12.0
    adx_center: 24.0
    adx_band: 12.0
    gap_ref_pips: 8.0
    gap_band_pips: 10.0
    vwap_ref: 16.0
    slope_ref_pips: 6.0
  be_profile:
    macro: {trigger_pips: 6.8, lock_ratio: 0.55, min_lock_pips: 2.6, cooldown_sec: 90}
    micro: {trigger_pips: 2.2, lock_ratio: 0.50, min_lock_pips: 0.60, cooldown_sec: 45}
    scalp: {trigger_pips: 1.6, lock_ratio: 0.35, min_lock_pips: 0.50, cooldown_sec: 20}
  start_delay_sec:
    micro: 25
    scalp: 12
  max_delay_sec:
    micro: 70
    scalp: 35
  tp_move:
    enabled: true
    macro: {trigger_pips: 6.0, buffer_pips: 2.5}
    micro: {trigger_pips: 2.0, buffer_pips: 1.0}
    scalp: {trigger_pips: 1.0, buffer_pips: 0.8}
  tp_move_min_gap_pips: 0.3
  exit_profile:
    min_hold_sec: 10
    profit_pips: 1.5
    trail_start_pips: 2.1
    trail_backoff_pips: 0.7
    lock_buffer_pips: 0.35
    range_profit_pips: 1.2
    range_trail_start_pips: 1.7
    range_trail_backoff_pips: 0.55
    range_lock_buffer_pips: 0.25
    range_max_hold_sec: 600
    loss_cut_enabled: false
    loss_cut_require_sl: true
    loss_cut_soft_pips: 12
    loss_cut_hard_pips: 30
    loss_cut_max_hold_sec: 1200
    loss_cut_cooldown_sec: 8
    loss_cut_reason_soft: m1_structure_break
    loss_cut_reason_hard: max_adverse
    loss_cut_reason_time: time_stop
    tick_imb:
      partial_enabled: true
      partial_trigger_pips: 1.0
      partial_fraction: 0.4
      partial_min_units: 1000
      partial_min_remaining: 1000
      be_buffer_pips: 0.2
      min_hold_sec: 0
      profit_pips: 0
      trail_start_pips: 0
      trail_backoff_pips: 0
      lock_buffer_pips: 0
      max_hold_sec: 0
      max_adverse_pips: 0
  pro_stop:
    enabled: true
    score_min: 2
    require_signal: true
    soft_pips: 3.4
    hard_pips: 9.5
    min_hold_sec: 203
    max_hold_sec: 1760

hold_until_profit:
  # TEMP (2026-02-07 JST): user requested "do not close" for specific scalp trades.
  # This blocks bot-initiated closes until the trade exceeds min_profit_pips.
  # Note: broker-side takeProfit/stopLoss can still close independently.
  trade_ids:
    - "313425"  # scalp LevelReject short opened 2026-02-07 06:40 JST
    - "313411"  # scalp WickReversal short opened 2026-02-07 06:25 JST
  min_profit_pips: 9999.0
  # strict=true blocks closes even for emergency / margin-relief reasons.
  strict: true

strategies:
  TrendMA:
    min_profit_pips: 1.0
    min_profit_ratio_reasons:
      - partial_take
      - lock_floor
      - trail_take
      - trail_lock
      - profit_lock
      - lock_trail
    be_profile: {trigger_pips: 7.0, lock_ratio: 0.60, min_lock_pips: 3.0, cooldown_sec: 90}
    tp_move: {trigger_pips: 7.5, buffer_pips: 3.0}
    pro_stop: {soft_pips: 1.6, hard_pips: 9.8, min_hold_sec: 113, max_hold_sec: 3437, soft_atr_mult: 1.0, hard_atr_mult: 1.8}
    neg_exit:
      allow_reasons:
        - hard_stop
        - tech_hard_stop
        - tech_return_fail
        - tech_reversal_combo
        - tech_candle_reversal
        - tech_nwave_flip
        - rsi_fade
        - vwap_cut
        - atr_spike
        - structure_break
        - trend_failure
        - trend_exhaust
        - reentry_reset
        - max_hold
        - max_adverse
        - time_stop
        - timeout
        - drawdown
        - max_drawdown
        - health_exit
        - hazard_exit
        - margin_health
        - free_margin_low
        - margin_usage_high

  H1Momentum:
    be_profile: {trigger_pips: 6.5, lock_ratio: 0.55, min_lock_pips: 2.8, cooldown_sec: 80}
    tp_move: {trigger_pips: 7.0, buffer_pips: 2.8}
    pro_stop: {soft_pips: 2.2, hard_pips: 34.1, min_hold_sec: 160, max_hold_sec: 1484, soft_atr_mult: 1.0, hard_atr_mult: 1.8}
    neg_exit:
      allow_reasons:
        - hard_stop
        - tech_hard_stop
        - tech_return_fail
        - tech_reversal_combo
        - tech_candle_reversal
        - tech_nwave_flip
        - rsi_fade
        - vwap_cut
        - atr_spike
        - structure_break
        - trend_failure
        - trend_exhaust
        - drawdown
        - max_drawdown
        - health_exit
        - hazard_exit
        - margin_health
        - free_margin_low
        - margin_usage_high

  trend_h1:
    be_profile: {trigger_pips: 5.5, lock_ratio: 0.55, min_lock_pips: 2.4, cooldown_sec: 75}
    tp_move: {trigger_pips: 6.2, buffer_pips: 2.4}
    pro_stop: {soft_pips: 2.2, hard_pips: 34.1, min_hold_sec: 160, max_hold_sec: 1484, soft_atr_mult: 1.0, hard_atr_mult: 1.8}
    neg_exit:
      allow_reasons:
        - hard_stop
        - tech_hard_stop
        - tech_return_fail
        - tech_reversal_combo
        - tech_candle_reversal
        - tech_nwave_flip
        - rsi_fade
        - vwap_cut
        - atr_spike
        - structure_break
        - trend_failure
        - trend_exhaust
        - drawdown
        - max_drawdown
        - health_exit
        - hazard_exit
        - margin_health
        - free_margin_low
        - margin_usage_high

  LondonMomentum:
    be_profile: {trigger_pips: 5.8, lock_ratio: 0.55, min_lock_pips: 2.4, cooldown_sec: 70}
    tp_move: {trigger_pips: 6.2, buffer_pips: 2.6}
    pro_stop: {soft_atr_mult: 1.0, hard_atr_mult: 1.8}

  manual_swing:
    be_profile: {trigger_pips: 6.0, lock_ratio: 0.55, min_lock_pips: 2.6, cooldown_sec: 90}
    tp_move: {trigger_pips: 6.8, buffer_pips: 2.8}
    pro_stop: {soft_atr_mult: 1.0, hard_atr_mult: 1.8}

  BB_RSI:
    be_profile: {trigger_pips: 1.8, lock_ratio: 0.52, min_lock_pips: 0.60, cooldown_sec: 35}
    tp_move: {trigger_pips: 1.4, buffer_pips: 0.9}
    pro_stop: {soft_pips: 2.14, hard_pips: 4.03, min_hold_sec: 121, max_hold_sec: 364, soft_atr_mult: 0.7, hard_atr_mult: 1.2}

  BB_RSI_Fast:
    be_profile: {trigger_pips: 1.6, lock_ratio: 0.55, min_lock_pips: 0.55, cooldown_sec: 30}
    tp_move: {trigger_pips: 1.2, buffer_pips: 0.8}
    pro_stop: {soft_atr_mult: 0.7, hard_atr_mult: 1.2}

  MicroRangeBreak:
    min_profit_pips: 0.2
    min_profit_ratio: 0.0
    be_profile: {trigger_pips: 1.8, lock_ratio: 0.50, min_lock_pips: 0.60, cooldown_sec: 35}
    tp_move: {trigger_pips: 1.5, buffer_pips: 0.9}
    pro_stop: {soft_pips: 3.4, hard_pips: 9.5, min_hold_sec: 203, max_hold_sec: 1760, soft_atr_mult: 0.8, hard_atr_mult: 1.4}
    exit_profile:
      # Micro trades often run without broker SL; cap tail loss mechanically using intended SL as a reference.
      loss_cut_enabled: true
      loss_cut_require_sl: false
      loss_cut_soft_pips: 0.0
      loss_cut_hard_pips: 0.0
      loss_cut_hard_sl_mult: 1.35
      loss_cut_max_hold_sec: 1800
      loss_cut_cooldown_sec: 6

  MicroVWAPBound:
    be_profile: {trigger_pips: 1.6, lock_ratio: 0.55, min_lock_pips: 0.60, cooldown_sec: 35}
    tp_move: {trigger_pips: 1.4, buffer_pips: 0.9}
    pro_stop: {soft_atr_mult: 0.7, hard_atr_mult: 1.2}
    neg_exit:
      allow_reasons:
        - reversion_*
    exit_profile:
      # VWAP-bound mean reversion can need room; avoid a tight "soft" cut while still capping tail risk.
      loss_cut_enabled: true
      loss_cut_require_sl: false
      loss_cut_soft_pips: 0.0
      loss_cut_hard_pips: 0.0
      loss_cut_hard_sl_mult: 1.60
      loss_cut_max_hold_sec: 2400
      loss_cut_cooldown_sec: 6

  MomentumBurst:
    be_profile: {trigger_pips: 1.8, lock_ratio: 0.50, min_lock_pips: 0.60, cooldown_sec: 35}
    tp_move: {trigger_pips: 1.5, buffer_pips: 0.9}
    pro_stop: {soft_pips: 4.8, hard_pips: 8.12, min_hold_sec: 306, max_hold_sec: 2382, soft_atr_mult: 0.8, hard_atr_mult: 1.4}
    exit_profile:
      loss_cut_enabled: true
      loss_cut_require_sl: false
      loss_cut_soft_pips: 0.0
      loss_cut_hard_pips: 0.0
      loss_cut_hard_sl_mult: 1.35
      loss_cut_max_hold_sec: 1800
      loss_cut_cooldown_sec: 6

  MicroLevelReactor:
    min_profit_pips: 0.2
    min_profit_ratio: 0.0
    be_profile: {trigger_pips: 1.4, lock_ratio: 0.56, min_lock_pips: 0.65, cooldown_sec: 30}
    tp_move: {trigger_pips: 1.2, buffer_pips: 0.8}
    pro_stop: {soft_atr_mult: 0.7, hard_atr_mult: 1.2}
    exit_profile:
      loss_cut_enabled: true
      loss_cut_require_sl: false
      loss_cut_soft_pips: 0.0
      loss_cut_hard_pips: 0.0
      loss_cut_hard_sl_mult: 1.55
      loss_cut_max_hold_sec: 2100
      loss_cut_cooldown_sec: 8

  mirror_spike:
    pro_stop: {soft_pips: 5.22, hard_pips: 11.69, min_hold_sec: 660, max_hold_sec: 1979, soft_atr_mult: 0.6, hard_atr_mult: 1.0}

  mirror_spike_tight:
    pro_stop: {soft_pips: 2.4, hard_pips: 4.13, min_hold_sec: 34, max_hold_sec: 288, soft_atr_mult: 0.6, hard_atr_mult: 1.0}

  Donchian55:
    pro_stop: {soft_pips: 9.84, hard_pips: 31.19, min_hold_sec: 815, max_hold_sec: 2836, soft_atr_mult: 1.0, hard_atr_mult: 1.8}

  Donchian5:
    pro_stop: {soft_pips: 6.84, hard_pips: 21.36, min_hold_sec: 859, max_hold_sec: 7200, soft_atr_mult: 1.0, hard_atr_mult: 1.8}

  MicroPullbackEMA:
    be_profile: {trigger_pips: 2.0, lock_ratio: 0.48, min_lock_pips: 0.65, cooldown_sec: 40}
    tp_move: {trigger_pips: 1.6, buffer_pips: 1.0}
    pro_stop: {soft_pips: 3.74, hard_pips: 6.82, min_hold_sec: 151, max_hold_sec: 1245, soft_atr_mult: 0.8, hard_atr_mult: 1.4}
    exit_profile:
      loss_cut_enabled: true
      loss_cut_require_sl: false
      loss_cut_soft_pips: 0.0
      loss_cut_hard_pips: 0.0
      loss_cut_hard_sl_mult: 1.35
      loss_cut_max_hold_sec: 1800
      loss_cut_cooldown_sec: 6

  MicroMomentumStack:
    be_profile: {trigger_pips: 2.2, lock_ratio: 0.45, min_lock_pips: 0.70, cooldown_sec: 45}
    tp_move: {trigger_pips: 1.8, buffer_pips: 1.1}
    pro_stop: {soft_atr_mult: 0.8, hard_atr_mult: 1.4}
    exit_profile:
      loss_cut_enabled: true
      loss_cut_require_sl: false
      loss_cut_soft_pips: 0.0
      loss_cut_hard_pips: 0.0
      loss_cut_hard_sl_mult: 1.35
      loss_cut_max_hold_sec: 1800
      loss_cut_cooldown_sec: 6

  TrendMomentumMicro:
    be_profile: {trigger_pips: 2.3, lock_ratio: 0.45, min_lock_pips: 0.70, cooldown_sec: 45}
    tp_move: {trigger_pips: 1.9, buffer_pips: 1.1}
    pro_stop: {soft_pips: 1.7, hard_pips: 2.4, min_hold_sec: 71, max_hold_sec: 312, soft_atr_mult: 0.8, hard_atr_mult: 1.4}
    exit_profile:
      loss_cut_enabled: true
      loss_cut_require_sl: false
      loss_cut_soft_pips: 0.0
      loss_cut_hard_pips: 0.0
      loss_cut_hard_sl_mult: 1.30
      loss_cut_max_hold_sec: 1500
      loss_cut_cooldown_sec: 6

  MicroVWAPRevert:
    min_profit_pips: 0.4
    min_profit_ratio: 0.0
    min_profit_ratio_min_tp_pips: 99.0
    be_profile: {trigger_pips: 1.6, lock_ratio: 0.55, min_lock_pips: 0.60, cooldown_sec: 35}
    tp_move: {trigger_pips: 1.3, buffer_pips: 0.9}
    pro_stop: {soft_atr_mult: 0.7, hard_atr_mult: 1.2}
    neg_exit:
      allow_reasons:
        - reversion_*
        - max_adverse
        - range_timeout
        - time_stop
        - timeout
        - lock_floor
        - trail_lock
        - near_be
        - drawdown
        - max_drawdown
        - margin_health
        - free_margin_low
        - margin_usage_high
        - candle_*
        - take_profit_zone
    exit_profile:
      loss_cut_enabled: true
      loss_cut_require_sl: false
      loss_cut_soft_pips: 0.0
      loss_cut_hard_pips: 0.0
      loss_cut_hard_sl_mult: 1.60
      loss_cut_max_hold_sec: 2400
      loss_cut_cooldown_sec: 6

  MicroCompressionRevert:
    exit_profile:
      min_hold_sec: 8
      profit_pips: 1.1
      trail_start_pips: 1.5
      trail_backoff_pips: 0.45
      lock_buffer_pips: 0.22
      range_profit_pips: 0.9
      range_trail_start_pips: 1.2
      range_trail_backoff_pips: 0.40
      range_lock_buffer_pips: 0.20
      range_max_hold_sec: 900
      loss_cut_enabled: true
      loss_cut_require_sl: false
      loss_cut_soft_pips: 0.0
      loss_cut_soft_sl_mult: 0.95
      loss_cut_hard_pips: 0.0
      loss_cut_hard_sl_mult: 1.20
      loss_cut_max_hold_sec: 900
      loss_cut_cooldown_sec: 4

  MicroTrendRetest:
    exit_profile:
      loss_cut_enabled: true
      loss_cut_require_sl: false
      loss_cut_soft_pips: 0.0
      loss_cut_hard_pips: 0.0
      loss_cut_hard_sl_mult: 1.35
      loss_cut_max_hold_sec: 1800
      loss_cut_cooldown_sec: 6

  TickImbalance:
    # TickImbalance is a fast scalp; keep profit-buffer low enough so partial/locks can execute.
    # Allow tiny-profit exits (lock_floor/range_timeout) to actually execute; otherwise they get rejected
    # and can turn into large time_stop losses.
    min_profit_pips: 0.3
    min_profit_ratio: 0.45
    # TickImbalance TP is small (<= ~2.5p). Disable min-profit-ratio gating for this strategy by requiring
    # a larger TP before the ratio check applies.
    min_profit_ratio_min_tp_pips: 3.0
    pro_stop: {soft_pips: 6.4, hard_pips: 12.07, min_hold_sec: 1200, max_hold_sec: 3600, soft_atr_mult: 0.6, hard_atr_mult: 1.0}
    exit_profile:
      # Let partial_take / BE arm quickly; holding 8s often misses the initial impulse.
      min_hold_sec: 2
      # Avoid profit-buffer rejects: keep take-profit >= min_profit_pips.
      profit_pips: 2.0
      trail_start_pips: 2.1
      trail_backoff_pips: 0.7
      lock_buffer_pips: 0.35
      range_profit_pips: 1.6
      range_trail_start_pips: 2.0
      range_trail_backoff_pips: 0.65
      range_lock_buffer_pips: 0.3
      range_max_hold_sec: 600
      loss_cut_enabled: true
      loss_cut_require_sl: false
      loss_cut_soft_pips: 6.0
      # NOTE: m1_structure_break is subject to EXIT_COMPOSITE gating and can block deterministic soft loss-cuts.
      # Use a non-composite reason so soft loss-cuts actually execute when needed.
      loss_cut_reason_soft: hard_stop
      loss_cut_hard_pips: 12.0
      loss_cut_max_hold_sec: 600
      loss_cut_cooldown_sec: 6
      tick_imb:
        partial_enabled: true
        partial_trigger_pips: 0.9
        partial_fraction: 0.4
        partial_min_units: 1000
        partial_min_remaining: 1000
        # After partial take, lock meaningful profit so a reversal doesn't bleed into time_stop/max_adverse.
        be_buffer_pips: 0.6
        min_hold_sec: 0
        # Use the main exit_profile (above) for profit/trailing; here we only tune TickImbalance-specific safety.
        profit_pips: 0.0
        trail_start_pips: 0.0
        trail_backoff_pips: 0.0
        lock_buffer_pips: 0.0
        max_hold_sec: 420
        max_adverse_pips: 4.0

  LevelReject:
    min_profit_pips: 1.4
    min_profit_ratio: 0.45
    pro_stop: {enabled: false}
    exit_profile:
      min_hold_sec: 10
      profit_pips: 2.3
      trail_start_pips: 2.6
      trail_backoff_pips: 0.6
      lock_buffer_pips: 0.3
      lock_floor_min_hold_sec: 60
      range_profit_pips: 2.3
      range_trail_start_pips: 2.6
      range_trail_backoff_pips: 0.55
      range_lock_buffer_pips: 0.26
      range_max_hold_sec: 1200
      loss_cut_enabled: true
      loss_cut_require_sl: false
      # Soft cut acts like a hidden hard SL for this strategy. Keep disabled.
      loss_cut_soft_pips: 0.0
      loss_cut_hard_pips: 10.5
      # Raise hard cut with volatility; base still applies when ATR is small.
      loss_cut_hard_atr_mult: 2.2
      # In stretched reversion context, allow more room instead of forcing max_adverse early.
      loss_cut_reversion_enabled: true
      loss_cut_reversion_hard_pips: 18.0
      loss_cut_reversion_vwap_gap_min: 18.0
      loss_cut_reversion_adx_max: 22.0
      loss_cut_reversion_rsi_short_min: 62.0
      loss_cut_reversion_rsi_long_max: 38.0
      loss_cut_max_hold_sec: 1200
      loss_cut_cooldown_sec: 6

  LiquiditySweep:
    min_profit_pips: 1.0
    min_profit_ratio: 0.45
    exit_profile:
      # LiquiditySweep often runs without broker SL (stopLossOnFill). Without a deterministic
      # loss cut, it can bleed until margin relief closes the trade. Cap tail risk mechanically.
      loss_cut_enabled: true
      loss_cut_require_sl: false
      # Avoid a tight "soft" cut (hidden hard-SL); keep only a tail cap + time stop.
      loss_cut_soft_pips: 0.0
      loss_cut_hard_pips: 12.0
      loss_cut_max_hold_sec: 1800
      loss_cut_cooldown_sec: 6

  TickWickReversal:
    min_profit_pips: 1.2
    min_profit_ratio: 0.45
    exit_profile:
      min_hold_sec: 6
      profit_pips: 1.1
      trail_start_pips: 1.5
      trail_backoff_pips: 0.55
      lock_buffer_pips: 0.25
      range_profit_pips: 1.0
      range_trail_start_pips: 1.4
      range_trail_backoff_pips: 0.5
      range_lock_buffer_pips: 0.22
      range_max_hold_sec: 240
      loss_cut_enabled: true
      loss_cut_require_sl: false
      loss_cut_soft_pips: 3.2
      loss_cut_hard_pips: 6.0
      loss_cut_max_hold_sec: 240
      loss_cut_cooldown_sec: 4
      loss_cut_reason_soft: max_adverse
      loss_cut_reason_hard: max_adverse
      loss_cut_reason_time: time_stop

  WickReversalHF:
    min_profit_pips: 1.0
    min_profit_ratio: 0.45
    exit_profile:
      # Wick-based fades are prone to small whipsaws; avoid a tight "soft" cut (hidden hard-SL).
      # Keep only a tail cap + time stop when running without broker SL.
      loss_cut_enabled: true
      loss_cut_require_sl: false
      loss_cut_soft_pips: 0.0
      loss_cut_hard_pips: 6.0
      # Use a composite reason so loss-cuts are allowed only on stronger invalidation signals.
      loss_cut_reason_hard: m1_structure_break
      loss_cut_max_hold_sec: 900
      loss_cut_cooldown_sec: 5

  WickReversalBlend:
    min_profit_pips: 0.6
    min_profit_ratio: 0.0
    min_profit_ratio_min_tp_pips: 99.0
    neg_exit:
      allow_reasons:
        - max_adverse
        - range_timeout
        - time_stop
        - timeout
        - lock_floor
        - trail_lock
        - near_be
        - drawdown
        - max_drawdown
        - margin_health
        - free_margin_low
        - margin_usage_high
    exit_profile:
      # Blend is a higher-quality wick fade with tick confirmation; still cap tail risk mechanically.
      loss_cut_enabled: true
      loss_cut_require_sl: false
      loss_cut_soft_pips: 0.0
      loss_cut_hard_pips: 6.0
      loss_cut_max_hold_sec: 900
      loss_cut_cooldown_sec: 5

  WickReversalPro:
    min_profit_pips: 1.0
    min_profit_ratio: 0.45
    exit_profile:
      loss_cut_enabled: true
      loss_cut_require_sl: false
      loss_cut_soft_pips: 0.0
      loss_cut_hard_pips: 6.0
      loss_cut_max_hold_sec: 900
      loss_cut_cooldown_sec: 5

  LevelRejectPlus:
    min_profit_pips: 1.0
    min_profit_ratio: 0.45
    exit_profile:
      # Level-based rejects can need room; avoid a small soft cut while still preventing tail blowups.
      loss_cut_enabled: true
      loss_cut_require_sl: false
      loss_cut_soft_pips: 0.0
      loss_cut_hard_pips: 8.0
      # Composite-gated: avoid stopping out reversion winners on a simple adverse spike.
      loss_cut_reason_hard: m1_structure_break
      loss_cut_max_hold_sec: 1800
      loss_cut_cooldown_sec: 6

  VwapRevertS:
    min_profit_pips: 1.0
    min_profit_ratio: 0.45
    exit_profile:
      # VWAP reversion can need time to mean-revert; avoid a tight "soft" loss cut which
      # behaves like a hidden hard-SL and can stop out winners. Keep only:
      # - a wide tail cap (hard)
      # - a time-based stop for trades that stay underwater too long
      loss_cut_enabled: true
      loss_cut_require_sl: false
      loss_cut_soft_pips: 0.0
      loss_cut_hard_pips: 12.0
      loss_cut_max_hold_sec: 2400
      loss_cut_cooldown_sec: 5

  SqueezePulseBreak:
    min_profit_pips: 1.2
    min_profit_ratio: 0.45
    # Lock profits earlier for breakout scalps: once in profit, move SL to protect gains.
    be_profile: {trigger_pips: 1.2, lock_ratio: 0.50, min_lock_pips: 0.60, cooldown_sec: 20}
    exit_profile:
      # Defaults have loss_cut disabled + require SL; SqueezePulseBreak often runs without broker SL.
      # Enable deterministic loss cuts to avoid tail losses when the breakout fails.
      loss_cut_enabled: true
      loss_cut_require_sl: false
      loss_cut_soft_pips: 3.8
      # Composite-gated: avoid stopping out trades that can still recover to TP.
      loss_cut_reason_soft: m1_structure_break
      loss_cut_hard_pips: 7.0
      loss_cut_reason_hard: m1_structure_break
      # Many TP-touches happen >7min after entry; don't time-stop too early while underwater.
      loss_cut_max_hold_sec: 1800
      loss_cut_cooldown_sec: 4

  FalseBreakFade:
    min_profit_pips: 1.0
    min_profit_ratio: 0.45
    exit_profile:
      # Fade setups can bleed for a long time if reclaim fails; cut deterministically without broker SL.
      loss_cut_enabled: true
      loss_cut_require_sl: false
      loss_cut_soft_pips: 3.8
      # Composite-gated: avoid stopping out short-lived fades that often mean-revert to TP.
      loss_cut_reason_soft: m1_structure_break
      loss_cut_hard_pips: 7.5
      loss_cut_reason_hard: m1_structure_break
      loss_cut_max_hold_sec: 1800
      loss_cut_cooldown_sec: 5

  MomentumPulse:
    be_profile: {trigger_pips: 1.7, lock_ratio: 0.50, min_lock_pips: 0.60, cooldown_sec: 35}
    tp_move: {trigger_pips: 1.4, buffer_pips: 0.9}
    pro_stop: {soft_pips: 3.4, hard_pips: 4.94, min_hold_sec: 112, max_hold_sec: 3601, soft_atr_mult: 0.8, hard_atr_mult: 1.4}
    exit_profile:
      loss_cut_enabled: true
      loss_cut_require_sl: false
      loss_cut_soft_pips: 0.0
      loss_cut_hard_pips: 0.0
      loss_cut_hard_sl_mult: 1.35
      loss_cut_max_hold_sec: 1800
      loss_cut_cooldown_sec: 6

  VolCompressionBreak:
    be_profile: {trigger_pips: 1.8, lock_ratio: 0.48, min_lock_pips: 0.60, cooldown_sec: 40}
    tp_move: {trigger_pips: 1.5, buffer_pips: 0.9}
    pro_stop: {soft_pips: 1.4, hard_pips: 3.8, min_hold_sec: 20, max_hold_sec: 7200, soft_atr_mult: 0.8, hard_atr_mult: 1.4}
    exit_profile:
      loss_cut_enabled: true
      loss_cut_require_sl: false
      loss_cut_soft_pips: 0.0
      loss_cut_hard_pips: 0.0
      loss_cut_hard_sl_mult: 1.30
      loss_cut_max_hold_sec: 1800
      loss_cut_cooldown_sec: 6

  RangeFader:
    be_profile: {trigger_pips: 1.0, lock_ratio: 0.45, min_lock_pips: 0.40, cooldown_sec: 12}
    tp_move: {trigger_pips: 0.8, buffer_pips: 0.6}
    start_delay_sec: 8
    max_delay_sec: 20
    pro_stop: {soft_pips: 4.68, hard_pips: 14.84, min_hold_sec: 353, max_hold_sec: 7200, soft_atr_mult: 0.6, hard_atr_mult: 1.0}
    neg_exit:
      allow_reasons:
        - reversion_*

  PulseBreak:
    be_profile: {trigger_pips: 1.4, lock_ratio: 0.38, min_lock_pips: 0.45, cooldown_sec: 15}
    tp_move: {trigger_pips: 1.1, buffer_pips: 0.7}
    start_delay_sec: 10
    max_delay_sec: 25
    pro_stop: {soft_atr_mult: 0.6, hard_atr_mult: 1.0}

  ImpulseRetrace:
    be_profile: {trigger_pips: 1.2, lock_ratio: 0.40, min_lock_pips: 0.45, cooldown_sec: 15}
    tp_move: {trigger_pips: 0.9, buffer_pips: 0.65}
    start_delay_sec: 10
    max_delay_sec: 25
    pro_stop: {soft_pips: 4.5, hard_pips: 19.5, min_hold_sec: 224, max_hold_sec: 1695, soft_atr_mult: 0.6, hard_atr_mult: 1.0}

  ImpulseRetraceScalp:
    be_profile: {trigger_pips: 1.2, lock_ratio: 0.40, min_lock_pips: 0.45, cooldown_sec: 15}
    tp_move: {trigger_pips: 0.9, buffer_pips: 0.65}
    start_delay_sec: 10
    max_delay_sec: 25
    pro_stop: {soft_atr_mult: 0.6, hard_atr_mult: 1.0}

  WickReversal:
    min_profit_pips: 1.0
    min_profit_ratio: 0.45
    exit_profile:
      loss_cut_enabled: true
      loss_cut_require_sl: false
      loss_cut_soft_pips: 0.0
      loss_cut_hard_pips: 6.0
      loss_cut_max_hold_sec: 900
      loss_cut_cooldown_sec: 5
  M1Scalper:
    min_profit_pips: 0.2
    min_profit_ratio: 0.0
    min_profit_ratio_min_tp_pips: 0.8
    exit_profile:
      min_hold_sec: 2
      profit_pips: 1.0
      trail_start_pips: 1.2
      trail_backoff_pips: 0.45
      lock_buffer_pips: 0.2
      range_profit_pips: 0.9
      range_trail_start_pips: 1.1
      range_trail_backoff_pips: 0.4
      range_lock_buffer_pips: 0.2
      range_max_hold_sec: 300
      loss_cut_enabled: true
      loss_cut_require_sl: false
      loss_cut_soft_pips: 0.0
      loss_cut_hard_pips: 0.0
      loss_cut_hard_sl_mult: 1.25
      loss_cut_max_hold_sec: 300
      loss_cut_cooldown_sec: 4

  scalp_macd_rsi_div_live:
    min_profit_pips: 0.2
    min_profit_ratio: 0.0
    exit_profile:
      min_hold_sec: 5
      loss_cut_enabled: true
      loss_cut_require_sl: false
      loss_cut_soft_pips: 0.0
      loss_cut_hard_pips: 7.0
      loss_cut_max_hold_sec: 1800
      loss_cut_cooldown_sec: 4

  scalp_ping_5s: &SCALP_PING_5S_EXIT_PROFILE
    # 5s ping scalp: lock small profits quickly to avoid giveback when flow stalls.
    start_delay_sec: 3
    max_delay_sec: 10
    be_profile: {trigger_pips: 0.65, lock_ratio: 0.52, min_lock_pips: 0.18, cooldown_sec: 3}
    tp_move: {enabled: true, trigger_pips: 0.75, buffer_pips: 0.25}
    exit_profile:
      # 取り残し対策: 新規建玉のみを対象に、反転検知+時間上限で tail を抑える。
      loss_cut_enabled: true
      loss_cut_require_sl: false
      # Soft は hidden hard-stop になりやすいため無効化し、方向反転シグナルを優先する。
      loss_cut_soft_pips: 0.0
      loss_cut_hard_pips: 8.0
      loss_cut_max_hold_sec: 1200
      loss_cut_cooldown_sec: 5
      # 非レンジの含み損を長時間放置しない（range_timeout 依存を回避）。
      non_range_max_hold_sec: 900
      direction_flip:
        enabled: true
        min_hold_sec: 90
        min_adverse_pips: 1.8
        # Suspicious phase: de-risk first, then full close only on stronger continuation.
        de_risk_enabled: true
        de_risk_threshold: 0.54
        de_risk_fraction: 0.40
        de_risk_min_units: 1000
        de_risk_min_remaining: 1000
        de_risk_cooldown_sec: 15
        de_risk_reason: risk_reduce
        score_threshold: 0.64
        release_threshold: 0.46
        confirm_hits: 3
        confirm_window_sec: 25
        cooldown_sec: 8
        forecast_weight: 0.35
        reason: m1_structure_break
    neg_exit:
      enabled: true
      strict_no_negative: true
      strict_allow_reasons:
        - profit_bank_release
        - hard_stop
        - tech_hard_stop
        - max_adverse
        - max_floating_loss
        - no_recovery
        - giveback_lock
        - time_stop
        - timeout
        - drawdown
        - max_drawdown
        - m1_structure_break
        - risk_reduce
        - health_exit
        - margin_health
        - free_margin_low
        - margin_usage_high
        - lock_floor
        - trail_lock
        - near_be
      allow_reasons:
        - profit_bank_release
        - hard_stop
        - tech_hard_stop
        - max_adverse
        - max_floating_loss
        - no_recovery
        - giveback_lock
        - time_stop
        - timeout
        - drawdown
        - max_drawdown
        - m1_structure_break
        - risk_reduce
        - health_exit
        - margin_health
        - free_margin_low
        - margin_usage_high
        - lock_floor
        - trail_lock
        - near_be
      deny_reasons:
        - take_profit
        - take_profit_zone

  scalp_ping_5s_live:
    # Live profile: prioritize early small-profit protection.
    start_delay_sec: 3
    max_delay_sec: 10
    be_profile: {trigger_pips: 0.65, lock_ratio: 0.52, min_lock_pips: 0.18, cooldown_sec: 3}
    tp_move: {enabled: true, trigger_pips: 0.75, buffer_pips: 0.25}
    exit_profile:
      loss_cut_enabled: true
      loss_cut_require_sl: false
      loss_cut_soft_pips: 0.0
      loss_cut_hard_pips: 8.0
      loss_cut_max_hold_sec: 1200
      loss_cut_cooldown_sec: 5
      non_range_max_hold_sec: 900
      direction_flip:
        enabled: true
        min_hold_sec: 90
        min_adverse_pips: 1.8
        de_risk_enabled: true
        de_risk_threshold: 0.54
        de_risk_fraction: 0.40
        de_risk_min_units: 1000
        de_risk_min_remaining: 1000
        de_risk_cooldown_sec: 15
        de_risk_reason: risk_reduce
        score_threshold: 0.64
        release_threshold: 0.46
        confirm_hits: 3
        confirm_window_sec: 25
        cooldown_sec: 8
        forecast_weight: 0.35
        reason: m1_structure_break
    neg_exit:
      enabled: true
      strict_no_negative: true
      strict_allow_reasons:
        - profit_bank_release
        - hard_stop
        - tech_hard_stop
        - max_adverse
        - max_floating_loss
        - no_recovery
        - giveback_lock
        - time_stop
        - timeout
        - drawdown
        - max_drawdown
        - m1_structure_break
        - risk_reduce
        - health_exit
        - margin_health
        - free_margin_low
        - margin_usage_high
        - lock_floor
        - trail_lock
        - near_be
      allow_reasons:
        - profit_bank_release
        - hard_stop
        - tech_hard_stop
        - max_adverse
        - max_floating_loss
        - no_recovery
        - giveback_lock
        - time_stop
        - timeout
        - drawdown
        - max_drawdown
        - m1_structure_break
        - risk_reduce
        - health_exit
        - margin_health
        - free_margin_low
        - margin_usage_high
        - lock_floor
        - trail_lock
        - near_be
    deny_reasons:
        - take_profit
        - take_profit_zone

  # B profile: keep direction logic but let profitable legs breathe longer.
  scalp_ping_5s_b:
    <<: *SCALP_PING_5S_EXIT_PROFILE
    exit_profile:
      profit_pips: 2.0
      trail_start_pips: 2.3
      trail_backoff_pips: 0.95
      lock_buffer_pips: 0.70
      lock_floor_min_hold_sec: 45
      range_profit_pips: 1.6
      range_trail_start_pips: 2.0
      range_trail_backoff_pips: 0.80
      range_lock_buffer_pips: 0.55
      # 取り残し対策: 新規建玉のみを対象に、反転検知+時間上限で tail を抑える。
      loss_cut_enabled: true
      loss_cut_require_sl: false
      # Soft は hidden hard-stop になりやすいため無効化し、方向反転シグナルを優先する。
      loss_cut_soft_pips: 0.0
      loss_cut_hard_pips: 8.0
      loss_cut_max_hold_sec: 1200
      loss_cut_cooldown_sec: 5
      # 非レンジの含み損を長時間放置しない（range_timeout 依存を回避）。
      non_range_max_hold_sec: 900
      # VM実測: short+MARKET_ORDER_TRADE_CLOSE の 900s+ が大幅マイナスのため短縮。
      non_range_max_hold_sec_short: 300
      direction_flip:
        enabled: true
        min_hold_sec: 90
        min_adverse_pips: 1.8
        # Suspicious phase: de-risk first, then full close only on stronger continuation.
        de_risk_enabled: true
        de_risk_threshold: 0.54
        de_risk_fraction: 0.40
        de_risk_min_units: 1000
        de_risk_min_remaining: 1000
        de_risk_cooldown_sec: 15
        de_risk_reason: risk_reduce
        score_threshold: 0.64
        release_threshold: 0.46
        confirm_hits: 3
        confirm_window_sec: 25
        cooldown_sec: 8
        forecast_weight: 0.35
        # shortの取り残しを抑えるため、逆行時は早期にde-risk/closeへ寄せる。
        short_min_hold_sec: 45
        short_min_adverse_pips: 1.0
        short_score_threshold: 0.56
        short_release_threshold: 0.42
        short_confirm_hits: 2
        short_confirm_window_sec: 18
        short_de_risk_threshold: 0.50
        short_forecast_weight: 0.45
        reason: m1_structure_break

  scalp_ping_5s_b_live:
    <<: *SCALP_PING_5S_EXIT_PROFILE
    exit_profile:
      profit_pips: 2.0
      trail_start_pips: 2.3
      trail_backoff_pips: 0.95
      lock_buffer_pips: 0.70
      lock_floor_min_hold_sec: 45
      range_profit_pips: 1.6
      range_trail_start_pips: 2.0
      range_trail_backoff_pips: 0.80
      range_lock_buffer_pips: 0.55
      # 取り残し対策: 新規建玉のみを対象に、反転検知+時間上限で tail を抑える。
      loss_cut_enabled: true
      loss_cut_require_sl: false
      # Soft は hidden hard-stop になりやすいため無効化し、方向反転シグナルを優先する。
      loss_cut_soft_pips: 0.0
      loss_cut_hard_pips: 8.0
      loss_cut_max_hold_sec: 1200
      loss_cut_cooldown_sec: 5
      # 非レンジの含み損を長時間放置しない（range_timeout 依存を回避）。
      non_range_max_hold_sec: 900
      direction_flip:
        enabled: true
        min_hold_sec: 90
        min_adverse_pips: 1.8
        # Suspicious phase: de-risk first, then full close only on stronger continuation.
        de_risk_enabled: true
        de_risk_threshold: 0.54
        de_risk_fraction: 0.40
        de_risk_min_units: 1000
        de_risk_min_remaining: 1000
        de_risk_cooldown_sec: 15
        de_risk_reason: risk_reduce
        score_threshold: 0.64
        release_threshold: 0.46
        confirm_hits: 3
        confirm_window_sec: 25
        cooldown_sec: 8
        forecast_weight: 0.35
        reason: m1_structure_break

  fast_scalp:
    min_profit_ratio: 0.45
    min_profit_ratio_min_tp_pips: 0.6
    be_profile: {trigger_pips: 1.2, lock_ratio: 0.40, min_lock_pips: 0.45, cooldown_sec: 12}
    tp_move: {trigger_pips: 0.9, buffer_pips: 0.6}
    pro_stop: {soft_pips: 1.2, hard_pips: 2.3, min_hold_sec: 15, max_hold_sec: 120, soft_atr_mult: 0.5, hard_atr_mult: 0.9}
    exit_profile:
      # Exit at a profile-defined drawdown threshold (see workers.fast_scalp.worker thesis hints).
      loss_cut_enabled: true
      loss_cut_require_sl: false
      loss_cut_soft_pips: 0.0
      # Hard/max-hold are injected from entry_thesis in workers.fast_scalp.exit_worker.
      loss_cut_hard_pips: 0.0
      loss_cut_max_hold_sec: 0.0
      loss_cut_cooldown_sec: 2
      loss_cut_reason_hard: drawdown
      loss_cut_reason_time: timeout

  OnePipMakerS1:
    be_profile: {trigger_pips: 0.9, lock_ratio: 0.45, min_lock_pips: 0.35, cooldown_sec: 10}
    tp_move: {trigger_pips: 0.7, buffer_pips: 0.5}
    pro_stop: {soft_atr_mult: 0.5, hard_atr_mult: 0.9}

  pullback_s5:
    be_profile: {trigger_pips: 1.2, lock_ratio: 0.40, min_lock_pips: 0.45, cooldown_sec: 14}
    tp_move: {trigger_pips: 0.9, buffer_pips: 0.6}
    pro_stop: {soft_atr_mult: 0.6, hard_atr_mult: 1.0}

  pullback_runner_s5:
    be_profile: {trigger_pips: 1.4, lock_ratio: 0.38, min_lock_pips: 0.45, cooldown_sec: 16}
    tp_move: {trigger_pips: 1.0, buffer_pips: 0.7}
    pro_stop: {soft_atr_mult: 0.6, hard_atr_mult: 1.0}

  impulse_break_s5:
    be_profile: {trigger_pips: 1.5, lock_ratio: 0.38, min_lock_pips: 0.50, cooldown_sec: 16}
    tp_move: {trigger_pips: 1.1, buffer_pips: 0.7}
    pro_stop: {soft_atr_mult: 0.6, hard_atr_mult: 1.0}

  impulse_retest_s5:
    be_profile: {trigger_pips: 1.3, lock_ratio: 0.40, min_lock_pips: 0.45, cooldown_sec: 15}
    tp_move: {trigger_pips: 1.0, buffer_pips: 0.7}
    pro_stop: {soft_pips: 5.0, hard_pips: 9.8, min_hold_sec: 282, max_hold_sec: 2141, soft_atr_mult: 0.6, hard_atr_mult: 1.0}
    exit_profile:
      loss_cut_enabled: true
      loss_cut_require_sl: false
      loss_cut_soft_pips: 0.0
      loss_cut_hard_pips: 0.0
      loss_cut_hard_sl_mult: 1.20
      loss_cut_max_hold_sec: 900
      loss_cut_cooldown_sec: 4

  impulse_momentum_s5:
    be_profile: {trigger_pips: 1.5, lock_ratio: 0.38, min_lock_pips: 0.50, cooldown_sec: 16}
    tp_move: {trigger_pips: 1.1, buffer_pips: 0.7}
    pro_stop: {soft_atr_mult: 0.6, hard_atr_mult: 1.0}

  vwap_magnet_s5:
    be_profile: {trigger_pips: 1.1, lock_ratio: 0.45, min_lock_pips: 0.40, cooldown_sec: 12}
    tp_move: {trigger_pips: 0.9, buffer_pips: 0.6}
    pro_stop: {soft_atr_mult: 0.6, hard_atr_mult: 1.0}

  MacroTechFusion:
    pro_stop: {soft_atr_mult: 1.0, hard_atr_mult: 1.8}

  MicroPullbackFib:
    pro_stop: {soft_atr_mult: 0.8, hard_atr_mult: 1.4}

  RangeCompressionBreak:
    pro_stop: {soft_atr_mult: 0.7, hard_atr_mult: 1.2}

  ScalpReversalNWave:
    pro_stop: {soft_atr_mult: 0.6, hard_atr_mult: 1.0}

  VolSpikeRider:
    pro_stop: {soft_atr_mult: 0.6, hard_atr_mult: 1.0}

  mm_lite:
    pro_stop: {soft_atr_mult: 0.5, hard_atr_mult: 0.9}
