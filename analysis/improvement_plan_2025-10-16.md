# QuantRabbit 改善タスク (2025-10-16)

## 背景
2025-10-15〜16 の USD/JPY 取引で `ScalpMeanRevert` を中心に損失が拡大し、15 分内レンジ変動とマージン強制決済が多発。分析で抽出した再発防止策を以下に整理する。

## 改善項目
1. **ボラティリティ連動ガード**  
   - 直近 15 分の M1 高安差が 10 pips 超、または直近 5 分レンジが 4 pips 超の場合 `ScalpMeanRevert` の新規エントリーを停止する。  
   - ガード発動時は理由と指標値をログへ残す。

2. **ストップ幅 / ブレークイーブン再設計**  
   - `ScalpMeanRevert` の初期ストップを最低 6 pips、ATR 連動で設定し、+2.5 pips 到達で建値+α へ引き上げる。  
   - トレンド追随モードでも同様に BE 調整を適用。

3. **ストップクラスター冷却**  
   - 5 分間の `STOP_LOSS_ORDER` が 5 件以上発生した場合、15 分間 `ScalpMeanRevert` を強制停止。  
   - 停止解除時刻を状態管理し、重複発動を防止する。

4. **ロット配分の見直し**  
   - スキャルポケットのデフォルト配分を 3% 程度へ縮小し、Macro/TrendMA へ比重を移す。  
   - `Scalp` の同時オープンポジション数上限を引き下げ（例: 2）る。

5. **フォーカス / レジーム補正**  
   - M1 で強いモメンタム（velocity ≥ 8 或いは 5 分レンジ ≥ 4）かつ H4/M1 が Trend/BREAKOUT のとき、フォーカスを `macro` 偏重 (≥0.65) に補正。  
   - レンジで高ボラティリティの際は `Scalp` を回避。

6. **モニタリング整備**  
   - 日次で `scripts/reconcile_pnl.py --hours 24` を実行できるチェック用スクリプトを追加し、OANDA と Firestore/SQLite の差分を検知する。  
   - 重要メトリクスをログ出力し、CI や cron で活用可能にする。

## 実施メモ
- 変更後は `analysis/trades_2025-10-15-16.csv` をベンチマークとして再度バックテスト/シミュレーションを行い、PF>1.1 を確認する。  
- すべての改善は Git 管理下で追跡し、ローカル検証とレビューを通過させる。
